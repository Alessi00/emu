var EmuLabeller={init:function(a){"use strict";var b=this;switch(b.USAGEMODE={SERVER:{value:0,name:"Server"},STANDALONE:{value:1,name:"Standalone"},NOT_CONFIGURED:{value:2,name:"NotConfigured"}},b.EDITMODE={STANDARD:{value:0,name:"StandardMode"},LABEL_RENAME:{value:1,name:"LabelRenameMode"},LABEL_MOVE:{value:2,name:"LabelRenameMode"},LABEL_RESIZE:{value:3,name:"DragingTierMode"},DRAGING_TIMELINE:{value:4,name:"DragingTimelineMode"},DRAGING_MINIMAP:{value:5,name:"DragingMinimapMode"},DRAGING_BAR:{value:6,name:"DragingBarMode"},DRAGING_TIER:{value:7,name:"DragingTierMode"},MODAL:{value:8,name:"ModalMode"}},this.internalMode=b.EDITMODE.STANDARD,this.externalMode=b.USAGEMODE.NOT_CONFIGURED,"server"===a.mode&&(this.externalMode=b.USAGEMODE.SERVER),"standalone"===a.mode&&(this.externalMode=b.USAGEMODE.STANDALONE),this.fileSelect=a.fileSelect,this.menuLeft=a.menuLeft,this.menuMain=a.menuMain,this.draggableBar=a.draggableBar,this.timeline=a.timeline,this.tiers=a.tiers,this.showLeftPush=a.showLeftPush,this.osciCanvas=a.osciCanvas,this.initLoad=a.initLoad,this.viewPort=Object.create(EmuLabeller.ViewPort),this.backend=Object.create(EmuLabeller.WebAudio),this.backend.init(a),this.drawer=Object.create(EmuLabeller.Drawer),this.drawer.init(a),this.labParser=Object.create(EmuLabeller.LabFileParser),this.iohandler=Object.create(EmuLabeller.IOhandler),this.iohandler.init(44100,this.externalMode),this.ssffParser=Object.create(EmuLabeller.SSFFparser),this.ssffParser.init(),this.JSONval=Object.create(EmuLabeller.JSONvalidator),this.JSONval.init(),this.tierHandler=Object.create(EmuLabeller.tierHandler),this.tierHandler.init(a),this.subMenuOpen=!1,this.dragingStart=0,this.resizeTierStart=0,this.relativeY=0,this.newFileType=-1,this.playMode="vP",this.clickedOn=0,this.selectedSegments=[],this.lastX=0,this.dragStart=-1,this.curLoadedBaseName="",this.exportData=null,this.oBottom=0,this.oTop=0,this.oTimeline=0,this.ssffInfos={data:[],canvases:[]},this.fileNames={audioFile:""},b.externalMode){case b.USAGEMODE.STANDALONE:b.showLeftPush.style.display="none";break;case b.USAGEMODE.SERVER:b.fileSelect.style.display="none";break;default:emulabeller.alertUser("Configuration Error","Please specify Usage mode 'server' or 'standalone' in main.js !"),b.fileSelect.style.display="none",b.showLeftPush.style.display="none"}this.backend.bindUpdate(function(){b.backend.isPaused()||b.onAudioProcess()}),document.addEventListener("mousedown",function(c){if(null!==b.getElement(c))var d=b.getElement(c).id;if(emulabeller.internalMode!=b.EDITMODE.MODAL)switch(d){case a.showLeftPush.id:b.openSubmenu();break;case"cmd_addTierSeg":b.tierHandler.addTier();break;case"cmd_addTierPoint":b.tierHandler.addTier(!0);break;case"cmd_about":window.scrollTo(0,0),$("#popup").dialog("option","position",["center",10]),$("#popup").dialog("open");break;case"cmd_download":var e=emulabeller.curLoadedBaseName+".TextGrid",f=emulabeller.iohandler.toTextGrid(emulabeller.tierHandler.getTiers());b.tierHandler.downloadDialog(e,f);break;case"cmd_doDownload":b.tierHandler.doDownload();break;case"cmd_viewZoomAll":b.setView(-1/0,1/0);break;case"cmd_viewZoomIn":b.zoomViewPort(1);break;case"cmd_viewZoomOut":b.zoomViewPort(0);break;case"cmd_viewMoveLeft":b.shiftViewP(0);break;case"cmd_viewMoveRight":b.shiftViewP(1);break;case"cmd_viewZoomSelect":b.zoomSel();break;case"cmd_playPause":b.playPauseInView();break;case"cmd_playSelected":b.playInMode("sel");break;case"cmd_playAll":b.playInMode("all");break;case"cmd_changeLabel":b.editLabel();break;case"cmd_dropBoxOpen":b.iohandler.dropBoxOpen();break;case"cmd_renameTierPoint":b.tierHandler.renameTier();break;case"cmd_resizeWave":emulabeller.tierHandler.resizeSpectroWave(!0);break;case"cmd_resizeSpectro":emulabeller.tierHandler.resizeSpectroWave(!1);break;case"cmd_disconnect":b.iohandler.disconnect();break;case"cmd_specSettings":window.scrollTo(0,0),$("#specDialog").dialog("option","position",["center",10]),$("#specDialog").dialog("open");break;case a.scrollCanvas.id:b.internalMode=b.EDITMODE.DRAGING_MINIMAP,b.tierHandler.removeLabelDoubleClick();var g=b.backend.currentBuffer.length,h=b.getX(c)*g,i=b.viewPort.eS-b.viewPort.sS;b.setView(h-i/2,h+i/2);break;case a.osciCanvas.id:case a.specCanvas.id:b.internalMode=b.EDITMODE.DRAGING_TIMELINE,b.tierHandler.removeLabelDoubleClick(),b.dragStart=Math.round(b.viewPort.sS+(b.viewPort.eS-b.viewPort.sS)*b.getX(c)),b.viewPort.selectS=b.dragStart,b.viewPort.selectE=b.dragStart,$("*").css("cursor","ew-resize"),c.preventDefault(),b.drawer.uiDrawUpdate();break;case a.draggableBar.id:b.internalMode=b.EDITMODE.DRAGING_BAR,b.tierHandler.removeLabelDoubleClick(),$("*").css("cursor","s-resize");break;default:return c.preventDefault(),c.stopPropagation(),!1}}),document.addEventListener("mouseup",function(a){if(emulabeller.internalMode!=b.EDITMODE.MODAL&&(b.internalMode=b.EDITMODE.STANDARD),$("*").css("cursor","auto"),b.internalMode==b.EDITMODE.DRAGING_TIMELINE)b.dragStart=-1,b.drawer.uiDrawUpdate();else if(b.internalMode==b.EDITMODE.DRAGING_BAR)b.dragingStartY=event.clientY,b.offsetTimeline=b.timeline.offsetHeight,b.offsetTiers=b.tiers.offsetHeight;else if(b.internalMode==b.EDITMODE.DRAGING_MINIMAP){var c=b.backend.currentBuffer.length,d=b.getX(a)*c,e=b.viewPort.eS-b.viewPort.sS;b.setView(d-e/2,d+e/2)}}),document.addEventListener("mousemove",function(a){if(1==a.which){if(b.internalMode==b.EDITMODE.DRAGING_TIMELINE){var c=Math.round(b.viewPort.sS+(b.viewPort.eS-b.viewPort.sS)*b.getX(a));c>=b.dragStart?(b.viewPort.selectE=c,b.viewPort.selectS=b.dragStart):(b.viewPort.selectS=c,b.viewPort.selectE=b.dragStart),b.drawer.uiDrawUpdate()}if(b.internalMode==b.EDITMODE.DRAGING_MINIMAP){var d=b.backend.currentBuffer.length,e=b.getX(a)*d,f=b.viewPort.eS-b.viewPort.sS;b.setView(e-f/2,e+f/2),b.drawer.uiDrawUpdate()}if(b.internalMode==b.EDITMODE.DRAGING_BAR){var g=$("#menu-bottom").offset(),h=$("#menu-bottom").height();console.log(g.top-h),event.clientY<=g.top-h&&($("*").css("cursor","s-resize"),$("#wave").css("height",event.clientY/2+"px"),$("#spectrogram").css("height",event.clientY/2+"px"),$("#timeline").css("height",10+$("#wave").height()+$("#spectrogram").height()+"px"),$("#spacer").height($("#timeline").height()+64+"px"))}}else b.lastX=b.getX(a),b.tierHandler.isEditing||emulabeller.internalMode!=emulabeller.EDITMODE.MODAL&&(b.internalMode=b.EDITMODE.STANDARD,$("*").css("cursor","auto"))}),document.addEventListener("contextmenu",function(a){a.preventDefault()}),$(window).resize(function(){b.tierHandler.removeLabelDoubleClick()}),$("#popup").dialog({bgiframe:!0,draggable:!1,resizable:!1,modal:!0,autoOpen:!1,width:500,height:500,show:{effect:"fade",duration:175},hide:{effect:"fade",duration:175},position:["center",10],open:function(){emulabeller.internalMode=emulabeller.EDITMODE.MODAL,window.onscroll=function(){window.scrollTo(0,0)}},beforeClose:function(){emulabeller.internalMode=emulabeller.EDITMODE.STANDARD,window.onscroll=function(){}}}),$("#alertDialog").dialog({bgiframe:!0,modal:!0,autoOpen:!1,draggable:!1,resizable:!1,width:500,height:"auto",show:{effect:"fade",duration:175},hide:{effect:"fade",duration:175},position:["center",10],buttons:{OK:function(){$(this).dialog("close")}},open:function(){emulabeller.internalMode=emulabeller.EDITMODE.MODAL,window.onscroll=function(){window.scrollTo(0,0)}},beforeClose:function(){emulabeller.internalMode=emulabeller.EDITMODE.STANDARD,window.onscroll=function(){}}}),$("#popup").dialog("option","position",["center",10]),this.dpr=1,void 0!==window.devicePixelRatio&&(this.dpr=window.devicePixelRatio),document.getElementById("wave").width=2048*this.dpr,document.getElementById("wave").height=224*this.dpr,document.getElementById("spectrogram").width=1024*this.dpr,document.getElementById("spectrogram").height=128*this.dpr,$("#wave").css("height","80px"),$("#spectrogram").css("height","80px"),$("#cans").sortable({tolerance:"pointer",cursor:"move",delay:5,dropOnEmpty:!0,start:function(){b.internalMode=b.EDITMODE.DRAGING_TIER,b.tierHandler.removeLabelDoubleClick()},stop:function(){b.internalMode=b.EDITMODE.STANDARD}}),$("#cans").disableSelection()},alertUser:function(a,b){window.scrollTo(0,0),$("#alertDialog").dialog("option","position",["center",10]),$("#alertDialog").dialog("option","title",a),$("#alertContent").html(b),$("#alertDialog").dialog("open")},confirmUser:function(a,b,c,d){window.scrollTo(0,0),$("#confirmDialog").dialog({bgiframe:!0,modal:!0,autoOpen:!1,width:500,height:"auto",show:{effect:"fade",duration:175},hide:{effect:"fade",duration:175},position:"center",buttons:{OK:function(){c(d),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},open:function(){emulabeller.internalMode=emulabeller.EDITMODE.MODAL,window.onscroll=function(){window.scrollTo(0,0)}},beforeClose:function(){emulabeller.internalMode=emulabeller.EDITMODE.STANDARD,window.onscroll=function(){}}}),$("#confirmDialog").dialog("option","position",["center",10]),$("#confirmDialog").dialog("option","title",a),$("#confirmContent").html(b),$("#confirmDialog").dialog("open")},start:function(){var a=this;switch(a.externalMode){case a.USAGEMODE.STANDALONE:break;case a.USAGEMODE.SERVER:this.iohandler.onConnected(function(b){a.connected(b)}),this.iohandler.onUtteranceList(function(b){a.availableUtterances(b)}),this.iohandler.start()}},connected:function(){console.log("Connected to emuSX")},availableUtterances:function(a){var b=this;if(1==a.length){var c=a[0],d=c.code;console.log("Request utterance ",d," from emuSX server"),this.iohandler.websocketLoad(d)}else{for(var e="cmd_load_utterance_",f=$("#utteranceList"),g="",h=0;h<a.length;h++){var i=a[h],d=i.code;g=g+'<a id="'+e+d+'" href="#">'+d+"</a>"}f.html(g);for(var h=0;h<a.length;h++){var i=a[h],d=i.code;$("#"+e+d).click(d,function(a){var c=a.target;c.id,b.iohandler.websocketLoad(a.data),b.openSubmenu()})}console.log("Update of available utterances"),this.openSubmenu()}},drawBuffer:function(){this.drawer.uiDrawUpdate()},onAudioProcess:function(){var a=this,b=0,c=this.backend.getPlayedPercents();this.viewPort.curCursorPosInPercent=c,"sel"==this.playMode&&(b=this.viewPort.selectE/this.backend.currentBuffer.length),"vP"==this.playMode&&this.backend.currentBuffer&&(b=this.viewPort.eS/this.backend.currentBuffer.length),"all"==this.playMode&&(b=1),this.backend.isPaused()||a.drawer.uiDrawUpdate(),c>b&&(a.drawer.uiDrawUpdate(),this.pause())},playInMode:function(a){var b,c;("vP"==a||null===a)&&(this.playMode="vP",b=this.viewPort.sS/this.backend.currentBuffer.length,c=this.viewPort.eS/this.backend.currentBuffer.length,this.backend.play(this.backend.getDuration()*b,this.backend.getDuration()*c)),("sel"==a||null===a)&&(this.playMode="sel",b=this.viewPort.selectS/this.backend.currentBuffer.length,c=this.viewPort.selectE/this.backend.currentBuffer.length,this.backend.play(this.backend.getDuration()*b,this.backend.getDuration()*c)),("all"==a||null===a)&&(this.playMode="all",this.backend.play(0,this.backend.getDuration()))},pause:function(){this.backend.pause()},playPauseInView:function(){this.backend.paused?this.playInMode("vP"):this.pause()},newlyLoadedBufferReady:function(){this.initLoad?this.initLoad=!1:emulabeller.confirmUser("Warning","Loading an audio file will delete all tiers!",emulabeller.tierHandler.reinit,""),this.viewPort.init(0,this.backend.currentBuffer.length-1,this.backend.currentBuffer.length,this.backend.currentBuffer.sampleRate),this.drawer.uiWaveDrawUpdate(),this.drawer.uiSpectroDrawUpdate(),this.drawer.uiMiniMapDraw(),this.drawer.uiAllTierDrawUpdate()},setView:function(a,b){var c=this.viewPort.sS,d=this.viewPort.eS;void 0!==a&&(this.viewPort.sS=Math.round(a)),void 0!==b&&(this.viewPort.eS=Math.round(b)),c>this.viewPort.sS&&d>this.viewPort.eS&&this.viewPort.sS<0&&(this.viewPort.sS=0,this.viewPort.eS=d+Math.abs(this.viewPort.sS)),c<this.viewPort.sS&&d<this.viewPort.eS&&this.viewPort.eS>this.backend.currentBuffer.length-1&&(this.viewPort.sS=c,this.viewPort.eS=this.backend.currentBuffer.length-1),this.viewPort.sS<0&&(this.viewPort.sS=0),this.viewPort.eS>this.backend.currentBuffer.length-1&&(this.viewPort.eS=this.backend.currentBuffer.length-1),this.viewPort.eS-this.viewPort.sS<4&&(this.viewPort.sS=c,this.viewPort.eS=d),this.drawBuffer()},zoomViewPort:function(a){this.tierHandler.removeLabelDoubleClick();var b,c,d=this.viewPort.curMouseMoveSegmentStart-this.viewPort.sS,e=this.viewPort.eS-this.viewPort.curMouseMoveSegmentStart,f=this.viewPort.eS-this.viewPort.sS;a?this.viewPort.curMouseMoveSegmentStart?(b=this.viewPort.sS+.5*d,c=this.viewPort.eS-.5*e):(b=this.viewPort.sS+~~(f/4),c=this.viewPort.eS-~~(f/4)):this.viewPort.curMouseMoveSegmentStart?(b=this.viewPort.sS-.5*d,c=this.viewPort.eS+.5*e):(b=this.viewPort.sS-~~(f/4),c=this.viewPort.eS+~~(f/4)),this.setView(b,c)},shiftViewP:function(a){var b,c;a?(b=this.viewPort.sS+~~((this.viewPort.eS-this.viewPort.sS)/4),c=this.viewPort.eS+~~((this.viewPort.eS-this.viewPort.sS)/4)):(b=this.viewPort.sS-~~((this.viewPort.eS-this.viewPort.sS)/4),c=this.viewPort.eS-~~((this.viewPort.eS-this.viewPort.sS)/4)),this.setView(b,c)},zoomSel:function(){this.setView(this.viewPort.selectS,this.viewPort.selectE)},getX:function(a){var b=a.offsetX;return null===b&&(b=a.layerX),b/a.srcElement.clientWidth},getY:function(a){var b=a.offsetY;return null===b&&(relX=a.layerY),b/a.srcElement.clientHeight},getTierID:function(a){return document.getElementById(a.srcElement.id).getAttribute("tier-id")},getTierName:function(a){return a.srcElement.id},getElement:function(a){return document.getElementById(a.srcElement.id)},keyBindingAllowed:function(a){var b=this;return 9==a||13==a?emulabeller.internalMode==b.EDITMODE.MODAL?!1:!0:b.internalMode!=b.EDITMODE.LABEL_RENAME?b.internalMode!=b.EDITMODE.MODAL?!0:!1:!1},parseNewFile:function(a){var b=this,c=emulabeller.newFileType;if(0===c)b.backend.loadData(a,b.newlyLoadedBufferReady.bind(b));else if(1==c){var d=emulabeller.labParser.parseFile(a,emulabeller.tierHandler.getLength());this.tierHandler.addLoadedTiers(d[0])}else if(2==c){var e="F0";b.tierHandler.addTiertoHtml(e,"-1","tierSettings","#signalcans");var f=emulabeller.ssffParser.parseSSFF(a);emulabeller.ssffInfos.data.push(f),emulabeller.ssffInfos.canvases.push($("#"+e)[0])}else if(3==c){var g=emulabeller.iohandler.parseTextGrid(a);this.tierHandler.addLoadedTiers(g)}},fileAPIread:function(a){var b=a.target.files[0],c=new FileReader;c.onload=function(){emulabeller.parseNewFile(c.result)},b.type.match("audio.*")?(console.log("is audio"),emulabeller.newFileType=0,c.readAsArrayBuffer(b)):b.name.match(".*TextGrid")?(console.log("is TextGrid"),emulabeller.newFileType=3,c.readAsText(b)):emulabeller.alertUser("File Read Error","File type not supported.... sorry!")},openSubmenu:function(){this.subMenuOpen?(this.subMenuOpen=!1,$("#serverSelect").html("Open Menu"),$("#menuLeft").removeClass("cbp-spmenu-open"),$("#timeline").css("left","0px"),$("#tierPush").css("left","0px")):(this.subMenuOpen=!0,$("#serverSelect").html("Close Menu"),$("#menuLeft").addClass("cbp-spmenu-open"),$("#timeline").css("left","240px"),$("#tierPush").css("left","240px"))},countSelected:function(a){var b=0;if(0===this.viewPort.length)return 0;if(0===this.viewPort.selectedSegments.length)return 0;if(null===a)a=0,$.each(this.viewPort.selectedSegments,function(){++a,$.each(this.viewPort.selectedSegments[a],function(){++b})});else{if(0===this.viewPort.selectedSegments.length)return 0;if(0===this.viewPort.selectedSegments[a].length)return 0;$.each(this.viewPort.selectedSegments[a],function(){++b})}return b},getSelectedSegmentDoubleClick:function(a){return this.viewPort.selectedSegments[a].indexOf(!0)},sendTierinfosToServer:function(){var a=this.tierHandler.tierInfos.tiers[this.viewPort.selTier];$.ajax({url:"http://127.0.0.1:8001/",type:"POST",contentType:"application/json",data:JSON.stringify(a),dataType:"json"})},validateTierInfos:function(){this.JSONval.validateTierInfos(this.tierHandler.tierInfos)},prepDownload:function(){try{var a=new Blob([emulabeller.iohandler.textGridHandler.toTextGrid(emulabeller.tierHandler.tierInfos.tiers)],{type:"text/plain"})}catch(b){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a.append(emulabeller.iohandler.textGridHandler.toTextGrid(emulabeller.tierHandler.tierInfos.tiers)),a=a.getBlob()}var c=emulabeller.iohandler.fileNames.label[emulabeller.iohandler.fileNames.label.length-1];$("#saveAsFileName").val(c),this.exportData=a},requestFromServer:function(a){console.log("sending message: ",a),this.socketIOhandler.doSend(a),"stopServer"==a&&window.close()}};EmuLabeller.WebAudio={Defaults:{fftSize:512,smoothingTimeConstant:0},init:function(a){a=a||{},this.ac=-1!==navigator.userAgent.indexOf("Firefox")?new window.AudioContext:new window.webkitAudioContext,this.fftSize=a.fftSize||this.Defaults.fftSize,this.destination=a.destination||this.ac.destination,this.analyser=this.ac.createAnalyser(),this.analyser.smoothingTimeConstant=a.smoothingTimeConstant||this.Defaults.smoothingTimeConstant,this.analyser.fftSize=this.fftSize,this.analyser.connect(this.destination),this.proc=-1!==navigator.userAgent.indexOf("Firefox")?this.ac.createScriptProcessor(this.fftSize/2,1,1):this.ac.createJavaScriptNode(this.fftSize/2,1,1),this.proc.connect(this.destination),this.dataArray=new Uint8Array(this.analyser.fftSize),this.paused=!0},bindUpdate:function(a){this.proc.onaudioprocess=a},setSource:function(a){this.source=a,this.source.connect(this.analyser),this.source.connect(this.proc),this.source.connect(this.destination)},loadData:function(a,b){var c=this;this.pause(),this.ac.decodeAudioData(a,function(a){c.currentBuffer=a,c.lastStart=0,c.lastPause=0,c.startTime=null,b(a)},Error)},isPaused:function(){return this.paused},getDuration:function(){return this.currentBuffer&&this.currentBuffer.duration},play:function(a,b,c){this.currentBuffer&&(this.pause(),this.setSource(this.ac.createBufferSource()),this.source.buffer=this.currentBuffer,this.lastStart=a,this.startTime=this.ac.currentTime,this.source.start(c,a,b-a),this.paused=!1)},pause:function(a){this.currentBuffer&&!this.paused&&(this.lastPause=this.getCurrentTime(),this.source.stop(a||0),this.paused=!0)},getPlayedPercents:function(){return this.getCurrentTime()/this.getDuration()>1&&this.pause(),this.getCurrentTime()/this.getDuration()},getCurrentTime:function(){return this.isPaused()?this.lastPause:this.lastStart+(this.ac.currentTime-this.startTime)},waveform:function(){return this.analyser.getByteTimeDomainData(this.dataArray),this.dataArray},frequency:function(){return this.analyser.getByteFrequencyData(this.dataArray),this.dataArray},loadBuffer:function(a,b,c){var d=new XMLHttpRequest;d.open("GET",b,!0),d.responseType="arraybuffer",d.onload=function(){var b=a.createBuffer(d.response,!1);c(b)},d.send()}},EmuLabeller.Drawer={defaultParams:{labelColor:"#000",osciColor:"#000",playProgressColor:"#777",playCursorColor:"#fff",playCursorWidth:4,loadingColor:"#333",loadingBackground:"#fff",loadingText:" calculating spectrogram  ... ",loadingBars:20,barHeight:1,barMargin:10,selectedAreaColor:"rgba(22, 22, 22, 0.2)",selectedBorderColor:"rgba(0, 0, 0, 0.7)",selectedBoundaryColor:"#0DC5FF",selectedTierColor:"rgba(22, 22, 22, 0.2)",selectedSegmentColor:"rgba(255, 255, 22, 0.5)",selectedMinimapColor:"rgba(0, 0, 0, 0.2)",startBoundaryColor:"#000",startBoundaryWidth:2,endBoundaryColor:"#888",endBoundaryWidth:2,zeroLineColor:"#0DC5FF",fontType:"Verdana",fontPxSize:20},init:function(a){var b=this;this.params=Object.create(a),Object.keys(this.defaultParams).forEach(function(c){c in a||(a[c]=b.defaultParams[c])}),this.osciDrawer=Object.create(EmuLabeller.Drawer.OsciDrawer),this.osciDrawer.init(a),this.spectogramDrawer=Object.create(EmuLabeller.Drawer.SpectogramDrawer),this.spectogramDrawer.init(a),this.SSFFDrawer=Object.create(EmuLabeller.Drawer.SSFFDrawer),this.SSFFDrawer.init(a),this.tierDrawer=Object.create(EmuLabeller.Drawer.TierDrawer),this.tierDrawer.init(a),this.osciCanvas=a.osciCanvas,this.specCanvas=a.specCanvas,this.scrollCanvas=a.scrollCanvas,this.osciWidth=this.osciCanvas.width,this.osciHeight=this.osciCanvas.height,this.start=0,this.end=this.osciWidth,this.specWidth=this.specCanvas.width,this.specHeight=this.specCanvas.height,this.scrollWidth=this.scrollCanvas.width,this.scrollHeight=8,this.inMemoryMiniMapCanvas=document.createElement("canvas"),this.inMemoryMiniMapCanvas.width=this.scrollWidth,this.inMemoryMiniMapCanvas.height=this.scrollCanvas.clientHeight,this.cc=this.osciCanvas.getContext("2d"),this.scc=this.specCanvas.getContext("2d"),this.scrollcc=this.scrollCanvas.getContext("2d"),this.cacheImage=new Image,this.isInitDraw=!0,a.image&&this.loadImage(a.image,this.drawImage.bind(this)),this.osciWidth&&this.osciHeight||console.error("Canvas size is zero.")},uiDrawUpdate:function(){this.uiWaveDrawUpdate(),this.uiSpectroDrawUpdate(),this.uiMiniMapDraw(),this.uiAllTierDrawUpdate()},uiMiniMapDraw:function(){this.isInitDraw&&(this.osciDrawer.drawCurOsciOnCanvas(this.inMemoryMiniMapCanvas),this.isInitDraw=!1),this.osciDrawer.drawScrollMarkup(this.inMemoryMiniMapCanvas)},uiWaveDrawUpdate:function(){this.osciDrawer.drawCurOsciOnCanvas(),this.osciDrawer.drawVpOsciMarkup()},uiSpectroDrawUpdate:function(){this.spectogramDrawer.uiDraw()},uiAllTierDrawUpdate:function(){var a=emulabeller.tierHandler.getTiers();for(var b in a)this.tierDrawer.drawSingleTier(a[b]),this.tierDrawer.drawVpMarkupSingleTier(a[b])},updateSingleTier:function(a,b,c){null!=a&&(this.tierDrawer.drawSingleTier(a,b,c),this.tierDrawer.drawVpMarkupSingleTier(a))}},EmuLabeller.Drawer.OsciDrawer={defaultParams:{},init:function(a){var b=this;this.params=Object.create(a),Object.keys(this.defaultParams).forEach(function(c){c in a||(a[c]=b.defaultParams[c])}),this.peaks=[],this.maxPeak=-1/0,this.minPeak=1/0,this.osciCanvas=a.osciCanvas,this.scrollCanvas=a.scrollCanvas,this.forTesting=1,this.showSampleNrs=!1},getPeaks:function(){var a=(emulabeller.viewPort.eS-emulabeller.viewPort.sS)/this.osciCanvas.width;this.peaks=[],this.minPeak=1/0,this.maxPeak=-1/0;var b,c=emulabeller.backend.currentBuffer.getChannelData(f);if(1>=a)b=0===emulabeller.viewPort.sS?c.subarray(emulabeller.viewPort.sS,emulabeller.viewPort.eS+2):c.subarray(emulabeller.viewPort.sS-1,emulabeller.viewPort.eS+2),this.minPeak=Math.min.apply(Math,b),this.maxPeak=Math.max.apply(Math,b),this.peaks=Array.prototype.slice.call(b);else{b=c.subarray(emulabeller.viewPort.sS,emulabeller.viewPort.eS);for(var d=0;d<this.osciCanvas.width;d++){for(var e=0,f=0;f<emulabeller.backend.currentBuffer.numberOfChannels;f++){for(var g=b.subarray(d*a,(d+1)*a),h=-1/0,i=0,j=0,k=g.length;k>j;j++)g[j]>h&&(h=g[j]),i+=g[j];e+=i/g.length}this.peaks[d]=e,e>this.maxPeak&&(this.maxPeak=e)}}},drawOsciOnCanvas:function(a){var b,c,d=this;a?(c=a.getContext("2d"),b=a):(c=this.osciCanvas.getContext("2d"),b=d.osciCanvas),c.font=this.params.fontPxSize+"px"+" "+this.params.fontType;var e=(emulabeller.viewPort.eS-emulabeller.viewPort.sS+1)/b.width;if(this.peaks&&e>=1)this.peaks.forEach(function(a,c){0!==c&&d.drawFrame(c,a,d.maxPeak,d.peaks[c-1],b,emulabeller.backend.currentBuffer)});else if(1>e){var f=1/e/2,g=emulabeller.viewPort.sS;c.strokeStyle=this.params.osciColor,c.fillStyle=this.params.osciColor,c.beginPath();var h;if(0===emulabeller.viewPort.sS){for(c.moveTo(f,(this.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height),h=0;h<this.peaks.length;h++)c.lineTo(h/e+f,(this.peaks[h]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height);for(c.stroke(),h=0;h<this.peaks.length;h++)c.beginPath(),c.arc(h/e+f,(this.peaks[h]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height-3,4,0,2*Math.PI,!1),c.stroke(),c.fill(),this.showSampleNrs&&(c.strokeText(g,h/e+f,(this.peaks[h]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height-10),g+=1)}else{for(c.moveTo(-f,b.height-(this.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height),h=1;h<this.peaks.length;h++)c.lineTo(h/e-f,b.height-((this.peaks[h]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height+3));for(c.stroke(),h=1;h<this.peaks.length;h++)c.beginPath(),c.arc(h/e-f,b.height-(this.peaks[h]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height-3,4,0,2*Math.PI,!1),c.stroke(),c.fill(),this.showSampleNrs&&(c.fillText(g,h/e-f,b.height-(this.peaks[h]-d.minPeak)/(d.maxPeak-d.minPeak)*b.height-10),g+=1)}}b==this.osciCanvas&&(c.strokeStyle=this.params.zeroLineColor,c.fillStyle=this.params.zeroLineColor,"Google Inc."==navigator.vendor&&c.setLineDash([5]),e>=1?(c.strokeRect(0,b.height/2,b.width,2),c.fillText("0",5,b.height/2-5,b.width)):(c.strokeRect(0,b.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*b.height,b.width,1),c.fillText("0",5,b.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*b.height-5,b.width)),"Google Inc."==navigator.vendor&&c.setLineDash([0]))},drawFrame:function(a,b,c,d,e){var f=e.getContext("2d"),g=emulabeller.viewPort.eS-emulabeller.viewPort.sS,h=emulabeller.viewPort.curCursorPosInPercent*emulabeller.viewPort.bufferLength-emulabeller.viewPort.sS,i=h/g,j=e.width*i,k=1,l=Math.round(b*(e.height/c)),m=a*k,n=Math.round((e.height-l)/2),o=Math.round(d*(e.height/c)),p=(a-1)*k,q=Math.round((e.height-o)/2);j>=m?(f.fillStyle=this.params.playProgressColor,f.strokeStyle=this.params.playProgressColor):(f.fillStyle=this.params.osciColor,f.strokeStyle=this.params.osciColor),f.beginPath(),f.moveTo(p,q),f.lineTo(m,n),f.stroke()},drawVpOsciMarkup:function(){var a=this.osciCanvas.getContext("2d");a.strokeStyle=this.params.labelColor,a.fillStyle=this.params.labelColor,a.font=this.params.fontPxSize+"px"+" "+this.params.fontType,a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(this.osciCanvas.width,0),a.lineTo(this.osciCanvas.width-5,5),a.closePath(),a.stroke();var b,c;if(emulabeller.viewPort){b=emulabeller.viewPort.round(emulabeller.viewPort.sS/emulabeller.viewPort.sampleRate,6),c=emulabeller.viewPort.round(emulabeller.viewPort.eS/emulabeller.viewPort.sampleRate,6),a.fillText(emulabeller.viewPort.sS,5,this.params.fontPxSize),a.fillText(b,5,2*this.params.fontPxSize);var d=a.measureText(b);a.fillText(emulabeller.viewPort.eS,this.osciCanvas.width-a.measureText(emulabeller.viewPort.eS).width-5,this.params.fontPxSize),a.fillText(c,this.osciCanvas.width-d.width-5,2*this.params.fontPxSize)}if(-1!==emulabeller.viewPort.selectS&&-1!==emulabeller.viewPort.selectE){var e,f=emulabeller.viewPort.getPos(this.osciCanvas.width,emulabeller.viewPort.selectS),g=emulabeller.viewPort.getPos(this.osciCanvas.width,emulabeller.viewPort.selectE),h=emulabeller.viewPort.getSampleDist(this.osciCanvas.width);if(emulabeller.viewPort.selectS==emulabeller.viewPort.selectE)e="seg"==emulabeller.viewPort.curMouseMoveTierType?0:h/2,a.fillStyle=this.params.selectedBorderColor,a.fillRect(f+e,0,1,this.osciCanvas.height),a.fillStyle=this.params.labelColor,a.fillText(emulabeller.viewPort.round(emulabeller.viewPort.selectS/emulabeller.viewPort.sampleRate+1/emulabeller.viewPort.sampleRate/2,6),f+e+5,this.params.fontPxSize),a.fillText(emulabeller.viewPort.selectS,f+e+5,2*this.params.fontPxSize);else{a.fillStyle=this.params.selectedAreaColor,a.fillRect(f,0,g-f,this.osciCanvas.height),a.strokeStyle=this.selBoundColor,a.beginPath(),a.moveTo(f,0),a.lineTo(f,this.osciCanvas.height),a.moveTo(g,0),a.lineTo(g,this.osciCanvas.height),a.closePath(),a.stroke(),a.fillStyle=this.params.labelColor;var i=a.measureText(emulabeller.viewPort.selectS).width;a.fillText(emulabeller.viewPort.selectS,f-i-4,this.params.fontPxSize),i=a.measureText(emulabeller.viewPort.round(emulabeller.viewPort.selectS/emulabeller.viewPort.sampleRate,6)).width,a.fillText(emulabeller.viewPort.round(emulabeller.viewPort.selectS/emulabeller.viewPort.sampleRate,6),f-i-4,2*this.params.fontPxSize),a.fillText(emulabeller.viewPort.selectE,g+5,this.params.fontPxSize),a.fillText(emulabeller.viewPort.round(emulabeller.viewPort.selectE/emulabeller.viewPort.sampleRate,6),g+5,2*this.params.fontPxSize),g-f>a.measureText(emulabeller.viewPort.round((emulabeller.viewPort.selectE-emulabeller.viewPort.selectS)/emulabeller.viewPort.sampleRate,6)).width&&(i=a.measureText(emulabeller.viewPort.selectE-emulabeller.viewPort.selectS).width,a.fillText(emulabeller.viewPort.selectE-emulabeller.viewPort.selectS-1,f+(g-f)/2-i/2,this.params.fontPxSize),i=a.measureText(emulabeller.viewPort.round((emulabeller.viewPort.selectE-emulabeller.viewPort.selectS)/emulabeller.viewPort.sampleRate,6)).width,a.fillText(emulabeller.viewPort.round((emulabeller.viewPort.selectE-emulabeller.viewPort.selectS)/emulabeller.viewPort.sampleRate,6),f+(g-f)/2-i/2,2*this.params.fontPxSize))}}if(emulabeller.viewPort.curCursorPosInPercent>0){var j=emulabeller.viewPort.getPos(this.osciCanvas.width,emulabeller.viewPort.curCursorPosInPercent*emulabeller.backend.currentBuffer.length);a.fillStyle=this.params.playCursorColor,a.strokeStyle=this.params.osciColor,a.fillRect(j-this.params.playCursorWidth/2,0,this.params.playCursorWidth,this.osciCanvas.height),a.strokeRect(j-this.params.playCursorWidth/2,0,this.params.playCursorWidth,this.osciCanvas.height)}},redrawOsciOnCanvas:function(a){var b=this.osciCanvas.height,c=this.osciCanvas.width,d=a.height,e=a.width;canvascc=a.getContext("2d"),canvascc.clearRect(0,0,e,d),canvascc.drawImage(this.osciCanvas,0,0,c,b,0,0,e,d)},drawCurOsciOnCanvas:function(a){var b,c;null!=a?(canvascc=a.getContext("2d"),b=a.height,c=a.width,osciWidth=a.width,osciHeight=a.height):(canvascc=this.osciCanvas.getContext("2d"),b=this.osciCanvas.height,c=this.osciCanvas.width,osciWidth=this.osciCanvas.width,osciHeight=this.osciCanvas.height),canvascc.clearRect(0,0,c,b),this.getPeaks(),this.drawOsciOnCanvas(a)},drawScrollMarkup:function(a){var b=this.scrollCanvas.height,c=this.scrollCanvas.width;canvascc=this.scrollCanvas.getContext("2d"),canvascc.globalCompositeOperation="lighter",canvascc.clearRect(0,0,c,b);var d=3,e=(emulabeller.viewPort.eS-emulabeller.viewPort.sS)/emulabeller.viewPort.bufferLength*c/2+2*d,f=emulabeller.viewPort.sS/emulabeller.viewPort.bufferLength*c+e;canvascc.globalAlpha=.7,canvascc.drawImage(a,0,0,c,b),canvascc.globalAlpha=1,canvascc.fillStyle=this.params.selectedMinimapColor,canvascc.fillRect(f-e,0,2*e,b),canvascc.fillRect(f-e,7*(b/8),2*e,b/8),canvascc.beginPath(),canvascc.arc(f+e,7*(b/8)+b/8/2,b/8/2,1.5*Math.PI,2.5*Math.PI,!1),canvascc.closePath(),canvascc.fill(),canvascc.fill(),canvascc.beginPath(),canvascc.arc(f-e,7*(b/8)+b/8/2,b/8/2,.5*Math.PI,1.5*Math.PI,!1),canvascc.closePath(),canvascc.fill(),canvascc.fill()}},EmuLabeller.Drawer.SpectogramDrawer={init:function(a){var b=this;b.myWindow={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},b.PI=3.141592653589793,b.TWO_PI=6.283185307179586,b.OCTAVE_FACTOR=3.321928094887363,b.emphasisPerOctave=3.9810717055349722,b.dynamicRange=5e3,b.dynRangeInDB=50,b.params=a,b.N=512,b.alpha=.16,b.windowFunction=b.myWindow.BARTLETTHANN,b.sampleRate=44100,b.channels=1,b.freq_lower=0,b.freq=8e3,b.canvas=a.specCanvas,b.context=a.specCanvas.getContext("2d"),b.pcmperpixel=0,b.myImage=new Image,b.font=a.font,window.URL=window.URL||window.webkitURL,b.devicePixelRatio=window.devicePixelRatio||1,b.response=spectroworker.textContent,b.blob;try{b.blob=new Blob([b.response],{type:"text/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b.blob.append(b.response),b.blob=b.blob.getBlob()}b.primeWorker=new Worker(URL.createObjectURL(b.blob)),b.setupEvent(),b.clearImageCache(),$("#specDialog").dialog({bgiframe:!0,modal:!0,autoOpen:!1,width:500,height:500,show:{effect:"fade",duration:175},hide:{effect:"fade",duration:175},position:"center",open:function(){emulabeller.internalMode=emulabeller.EDITMODE.MODAL,window.onscroll=function(){window.scrollTo(0,0)}},beforeClose:function(){emulabeller.internalMode=emulabeller.EDITMODE.STANDARD,window.onscroll=function(){}},buttons:{OK:function(){var a=$("#windowLength").val(),c=$("#viewrange_from").val(),d=$("#viewrange_to").val(),e=$("#dynamicRange").val(),f=$("#windowFunction").val();isNaN(a)||isNaN(c)||isNaN(d)||isNaN(e)?alert("Please enter valid numbers !"):(b.N=parseInt(a,10),b.freq=parseInt(d,10),b.freq_lower=parseInt(c,10),b.dynRangeInDB=parseInt(e,10),b.windowFunction=parseInt(f,10),b.clearImageCache(),b.killSpectroRenderingThread(),b.uiDraw(),b.drawTimeLine(),$(this).dialog("close"))
},Cancel:function(){$(this).dialog("close")}}})},setupEvent:function(){var a=this;a.primeWorker.addEventListener("message",function(b){a.worker_img=b.data.img,a.worker_start=b.data.start,a.worker_end=b.data.end,a.worker_cache_width=b.data.cacheWidth,a.worker_cache_side=b.data.cacheSide,a.render_width=a.canvas.width-a.worker_cache_width,a.myImage.onload=function(){0==a.worker_cache_side&&a.context.drawImage(a.myImage,0,0,a.canvas.width,a.canvas.height,0,0,a.canvas.width,a.canvas.height),1==a.worker_cache_side&&a.context.drawImage(a.myImage,0,0,a.render_width,a.canvas.height,0,0,a.render_width,a.canvas.height),2==a.worker_cache_side&&a.context.drawImage(a.myImage,a.worker_cache_width,0,a.render_width,a.canvas.height,a.worker_cache_width,0,a.render_width,a.canvas.height),a.buildImageCache(a.worker_start,a.worker_end,a.canvas.toDataURL("image/png")),a.drawTimeLineContext()},a.myImage.src=a.worker_img})},buildImageCache:function(a,b,c){var d=this;null==d.imageCache[d.pcmperpixel]&&(d.imageCache[d.pcmperpixel]=new Array),null==d.imageCacheCounter[d.pcmperpixel]&&(d.imageCacheCounter[d.pcmperpixel]=0),null==d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]]&&(d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]]=new Array,d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]][0]=a,d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]][1]=b,d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]][2]=c,++d.imageCacheCounter[d.pcmperpixel])},drawTimeLineContext:function(){var a=this,b=emulabeller.viewPort.getPos(a.canvas.width,emulabeller.viewPort.selectS),c=emulabeller.viewPort.getPos(a.canvas.width,emulabeller.viewPort.selectE),d=emulabeller.viewPort.getSampleDist(a.canvas.width)/2,e=b+d;0!=b&&emulabeller.viewPort.selectS==emulabeller.viewPort.selectE&&(a.context.fillStyle=a.params.selectLineColor,a.context.fillRect(e,0,1,a.canvas.height)),0!=e&&emulabeller.viewPort.selectS!=emulabeller.viewPort.selectE&&(a.context.fillStyle=a.params.selectedAreaColor,a.context.fillRect(b,0,c-b,a.canvas.height),a.context.strokeStyle=a.params.selectLineColor,a.context.beginPath(),a.context.moveTo(b,0),a.context.lineTo(b,a.canvas.height),a.context.moveTo(c,0),a.context.lineTo(c,a.canvas.height),a.context.closePath(),a.context.stroke())},drawTimeLine:function(){var a=this,b=new Image;b.onload=function(){a.context.drawImage(b,0,0),a.drawTimeLineContext()},b.src=this.myImage.src},killSpectroRenderingThread:function(){var a=this;a.context.fillStyle=a.params.selectedBorderColor,a.context.fillRect(0,0,a.canvas.width,a.canvas.height),a.context.font=a.params.fontPxSize+"px "+a.params.fontType,a.context.fillStyle=a.params.loadingBackground,a.context.fillText(a.params.loadingText,10,25),null!=a.primeWorker&&(a.primeWorker.terminate(),a.primeWorker=null)},clearImageCache:function(){var a=this;a.imageCache=null,a.imageCacheCounter=null,a.imageCache=new Array,a.imageCacheCounter=new Array},uiDraw:function(){var a=this;if(a.newpcmperpixel=Math.round((emulabeller.viewPort.eS-emulabeller.viewPort.sS)/a.canvas.width),null!=a.imageCache)if(null!=a.imageCache[a.newpcmperpixel]){for(var b=0;b<a.imageCache[a.newpcmperpixel].length;++b)if(a.imageCache[a.newpcmperpixel][b][0]==emulabeller.viewPort.sS&&a.imageCache[a.newpcmperpixel][b][1]==emulabeller.viewPort.eS)return a.myImage.src=a.imageCache[a.newpcmperpixel][b][2],a.drawTimeLine(),void 0;a.killSpectroRenderingThread(),a.startSpectroRenderingThread()}else a.killSpectroRenderingThread(),a.startSpectroRenderingThread();else a.killSpectroRenderingThread(),a.startSpectroRenderingThread()},startSpectroRenderingThread:function(){var a=this;a.pcmperpixel=Math.round((emulabeller.viewPort.eS-emulabeller.viewPort.sS)/a.canvas.width),a.primeWorker=new Worker(URL.createObjectURL(a.blob)),a.setupEvent(),a.primeWorker.postMessage({cmd:"config",N:a.N}),a.primeWorker.postMessage({cmd:"config",alpha:a.alpha}),a.primeWorker.postMessage({cmd:"config",freq:a.freq}),a.primeWorker.postMessage({cmd:"config",freq_low:a.freq_lower}),a.primeWorker.postMessage({cmd:"config",start:Math.round(emulabeller.viewPort.sS)}),a.primeWorker.postMessage({cmd:"config",end:Math.round(emulabeller.viewPort.eS)}),a.primeWorker.postMessage({cmd:"config",myStep:a.pcmperpixel}),a.primeWorker.postMessage({cmd:"config",window:a.windowFunction}),a.primeWorker.postMessage({cmd:"config",cacheSide:0}),a.primeWorker.postMessage({cmd:"config",width:a.canvas.width}),a.primeWorker.postMessage({cmd:"config",height:a.canvas.height}),a.primeWorker.postMessage({cmd:"config",cacheWidth:0}),a.primeWorker.postMessage({cmd:"config",dynRangeInDB:a.dynRangeInDB}),a.primeWorker.postMessage({cmd:"config",pixelRatio:a.devicePixelRatio}),a.primeWorker.postMessage({cmd:"pcm",config:JSON.stringify(emulabeller.backend.currentBuffer)}),a.primeWorker.postMessage({cmd:"pcm",stream:emulabeller.backend.currentBuffer.getChannelData(0).subarray(emulabeller.viewPort.sS,emulabeller.viewPort.eS+2*a.N)}),a.primeWorker.postMessage({cmd:"render"})}},EmuLabeller.Drawer.TierDrawer={defaultParams:{},init:function(a){var b=this;this.params=Object.create(a),Object.keys(this.defaultParams).forEach(function(c){c in a||(a[c]=b.defaultParams[c])})},drawSingleTier:function(a,b,c){var d=emulabeller.tierHandler.getCanvas(a.TierName),e=emulabeller.tierHandler.getCanvasContext(a.TierName);d.width*b,d.height*c;var f=emulabeller.viewPort.getSampleDist(d.width);if(a.TierName==emulabeller.viewPort.getSelectTier()?(e.clearRect(0,0,d.width,d.height),e.fillStyle=this.params.selectedTierColor,e.fillRect(0,0,d.width,d.height)):e.clearRect(0,0,d.width,d.height),e.fillStyle=this.params.labelColor,e.font=this.params.fontPxSize+"px"+" "+this.params.fontType,e.fillText(a.TierName,5,this.params.fontPxSize),e.fillText("("+a.type+")",5,2*this.params.fontPxSize),"seg"==a.type){var g=a.events;for(var h in g){var i=g[h];if(i.startSample>emulabeller.viewPort.sS&&i.startSample<emulabeller.viewPort.eS||i.startSample+i.sampleDur>emulabeller.viewPort.sS&&i.startSample+i.sampleDur<emulabeller.viewPort.eS||i.startSample<emulabeller.viewPort.sS&&i.startSample+i.sampleDur>emulabeller.viewPort.eS){var j=Math.round(emulabeller.viewPort.getPos(d.width,i.startSample)),k=emulabeller.viewPort.curMouseMoveTierName,l=emulabeller.viewPort.curMouseMoveSegmentName,m=emulabeller.viewPort.getId(a,i.label,i.startSample);a.TierName==k&&l==m?(e.fillStyle=this.params.selectedBoundaryColor,e.fillRect(j-4,0,8,d.height)):(e.fillStyle=this.params.startBoundaryColor,e.fillRect(j,0,this.params.startBoundaryWidth,d.height/2));var n=Math.round(emulabeller.viewPort.getPos(d.width,i.startSample+i.sampleDur+1));if(e.fillStyle=this.params.endBoundaryColor,e.fillRect(n,d.height/2,this.params.endBoundaryWidth,d.height),emulabeller.viewPort.isSelected(a,i.label,i.startSample)&&(e.fillStyle=this.params.selectedSegmentColor,e.fillRect(j,0,n-j,d.height)),e.fillStyle=this.params.labelColor,tW=e.measureText(i.label).width,tX=j+(n-j)/2-tW/2,n-j>tW&&e.fillText(i.label,tX,d.height/2+3),n-j>3*e.measureText("m").width){e.strokeStyle=this.params.startBoundaryColor,e.beginPath(),e.moveTo(j,d.height/4),e.lineTo(tX+tW/2,d.height/4),e.lineTo(tX+tW/2,d.height/4+10),e.stroke(),e.fillStyle=this.params.startBoundaryColor;var o=e.measureText(i.startSample).width;n-j>o&&e.fillText(i.startSample,j+5,d.height/8+this.params.fontPxSize/2),e.strokeStyle=this.params.endBoundaryColor,e.beginPath(),e.moveTo(n,3*(d.height/4)),e.lineTo(tX+tW/2,3*(d.height/4)),e.lineTo(tX+tW/2,3*(d.height/4)-10),e.stroke()}e.fillStyle=this.params.endBoundaryColor;var p=e.measureText("dur: "+i.sampleDur).width;n-j>p&&e.fillText("dur: "+i.sampleDur,n-p-5,d.height-d.height/8)}}}else if("point"==a.type){e.fillStyle=this.params.startBoundaryColor;for(h in a.events){var i=a.events[h],q=emulabeller.viewPort.getId(a,i.label,i.startSample);i.startSample>emulabeller.viewPort.sS&&i.startSample<emulabeller.viewPort.eS&&(perc=Math.round(emulabeller.viewPort.getPos(d.width,i.startSample)+f/2),a.TierName==emulabeller.viewPort.curMouseMoveTierName&&q==emulabeller.viewPort.curMouseMoveSegmentName?(e.fillStyle=this.params.selectedBoundaryColor,e.fillRect(perc,0,8,d.height/2-d.height/10),e.fillRect(perc,d.height/2+d.height/10,8,d.height/2-d.height/10),tW=e.measureText(a.events[h].label).width,e.fillStyle=this.params.labelColor,e.fillText(a.events[h].label,perc-tW/2+1,d.height/2)):(e.fillStyle=this.params.startBoundaryColor,e.fillRect(perc,0,1,d.height/2-d.height/10),e.fillRect(perc,d.height/2+d.height/10,1,d.height/2-d.height/10),tW=e.measureText(a.events[h].label).width,e.fillStyle=this.params.labelColor,e.fillText(a.events[h].label,perc-tW/2+1,d.height/2)),e.fillStyle=this.startBoundaryColor,tW=e.measureText(i.startSample).width,e.fillText(i.startSample,perc+5,d.height/8))}}},drawVpMarkupSingleTier:function(a){var b,c=this,d=emulabeller.tierHandler.getCanvas(a.TierName),e=emulabeller.tierHandler.getCanvasContext(a.TierName),f=Math.round(emulabeller.viewPort.getPos(d.width,emulabeller.viewPort.selectS)),g=emulabeller.viewPort.getPos(d.width,emulabeller.viewPort.selectE),h=emulabeller.viewPort.getSampleDist(d.width);if(e.strokeStyle=this.params.selectedBorderColor,e.fillStyle=this.params.selectedBorderColor,emulabeller.viewPort.selectS==emulabeller.viewPort.selectE){if(-1!==emulabeller.viewPort.selectS){b="seg"==emulabeller.viewPort.curMouseMoveTierType?0:h/2;var i=f;e.fillRect(i-5+b,0,10,10),e.beginPath(),e.moveTo(i+b,10),e.lineTo(i+b,d.height),e.stroke()}}else e.fillStyle=c.params.selectedAreaColor,e.fillRect(f,0,g-f,d.height),e.beginPath(),e.moveTo(f,0),e.lineTo(f,d.height),e.moveTo(g,0),e.lineTo(g,d.height),e.stroke();var j=emulabeller.viewPort.curCursorPosInPercent*emulabeller.viewPort.bufferLength-emulabeller.viewPort.sS,k=j/(emulabeller.viewPort.eS-emulabeller.viewPort.sS+1),l=d.width*k;e.strokeStyle=this.cursorColor;var m=this.cursorWidth,n=d.height;e.fillStyle=this.cursorColor,l>0&&e.fillRect(l,0,m,n)}},EmuLabeller.Drawer.SSFFDrawer={defaultParams:{},init:function(a){var b=this;this.params=Object.create(a),Object.keys(this.defaultParams).forEach(function(c){c in a||(a[c]=b.defaultParams[c])}),this.markColor="rgba(255, 255, 0, 0.7)",this.boundaryColor="white",this.selBoundColor="red"},drawSSFF:function(a,b){var c=a.canvases[0].getContext("2d");if(!a.data[0].maxF0){console.log("calculating max f0"),a.data[0].maxF0=-1/0;for(var d=0;d<a.data[0].Columns[0].values.length;d++)a.data[0].Columns[0].values[d][0]>a.data[0].maxF0&&(a.data[0].maxF0=a.data[0].Columns[0].values[d][0])}var e=1/a.data[0].Record_Freq;a.data[0].Start_Time;var f=a.data[0].maxF0,g=a.canvases[0].clientHeight,h=a.canvases[0].clientWidth;c.clearRect(0,0,h,g),(b.eS-b.sS)/this.osciWidth;var i=Math.floor(b.sS/44100/e)+1,j=Math.ceil(b.eS/44100/e),k=(j-i)/this.osciWidth;c.strokeStyle=this.params.waveColor,c.font="12px Verdana",c.strokeText(a.data[0].Columns[0].name,5,13),c.strokeStyle="rgba(0,0,255,0.5)",c.fillStyle="rgba(0,0,255,0.5)";for(var d=1;j-i>d;d++)c.beginPath(),c.moveTo((d-1)/k,g-a.data[0].Columns[0].values[i+d-1][0]/f*g),c.lineTo(d/k,g-a.data[0].Columns[0].values[i+d][0]/f*g),c.stroke(),c.beginPath(),c.arc(d/k,g-a.data[0].Columns[0].values[i+d][0]/f*g,1,0,2*Math.PI,!0),c.closePath(),c.fill()}},EmuLabeller.ViewPort={init:function(a,b,c,d){this.sS=a,this.eS=b,this.selectS=-1,this.selectE=-1,this.bufferLength=c,this.sampleRate=d,this.percent=-1,this.uiInfo=[],this.selectInfo=[],this.resetSelection(),this.MouseTierName="",this.MouseSegmentName="",this.curMouseMoveTierName="",this.curMouseMoveTierType="",this.curMouseMoveSegmentName="",this.curMouseMoveSegmentStart="",this.curMouseMoveSegmentDuration="",this.selectSPixel=0,this.selectEPixel=0,this.curCursorPosInPercent=0},select:function(a,b){this.selectS=a,this.selectE=b},selectMove:function(a,b){this.curMouseMoveTierName=a.TierName,this.curMouseMoveTierType=a.type,this.curMouseMoveSegmentName=this.getId(a,b.label,b.startSample),this.curMouseMoveSegmentStart=b.startSample,this.curMouseMoveSegmentDuration=b.sampleDur},getPos:function(a,b){return a*(b-this.sS)/(this.eS-this.sS+1)},getSampleDist:function(a){return this.getPos(a,this.sS+1)-this.getPos(a,this.sS)},setSelectTier:function(a){this.MouseTierName=a},getSelectTier:function(){return this.MouseTierName},getSelectName:function(){return console.log(this.MouseSegmentName),this.MouseSegmentName},setSelectName:function(a){this.MouseSegmentName=a},setSelectSegment:function(a,b,c){var d=this.getId(a,b.label,b.startSample);this.MouseSegmentName=d,this.uiInfo[d]=c,this.resizeSelectArea(b.startSample,b.startSample+b.sampleDur+1)},setSelectPoint:function(a,b,c){var d=this.getId(a,b.label,b.startSample);this.MouseSegmentName=d,this.uiInfo[d]=c,this.resizeSelectArea(b.startSample,b.startSample)},resizeSelectArea:function(a,b){this.selectS=a,this.selectE=b},resizeSelectAreaMulti:function(a,b){a<this.selectS&&(this.selectS=a),b>this.selectE&&(this.selectE=b)},setSelectMultiSegment:function(a,b,c,d,e){var f=this.getId(a,b.label,b.startSample);return emulabeller.viewPort.uiInfo[f-1]||emulabeller.viewPort.uiInfo[f+1]||e?(emulabeller.viewPort.uiInfo[f]=c,e||emulabeller.viewPort.resizeSelectAreaMulti(b.startSample,b.startSample+b.sampleDur+1),!0):!1},isSelected:function(a,b,c){return a.TierName==this.getSelectTier()?this.uiInfo[this.getId(a,b,c)]:!1},getAllSelected:function(a){var b=[],c=0;if(a.TierName==this.getSelectTier()){for(e in a.events)this.uiInfo[c]&&(b[c]=a.events[e]),c++;return b}return!1},countSelected:function(){for(var a=0,b=0;b<this.uiInfo.length;b++)this.uiInfo[b]&&a++;return a},getCurrentSample:function(a){return this.sS+(this.eS-this.sS)*a},getCurrentPercent:function(a){return a*(100/(this.eS-this.sS)/100)},getId:function(a,b,c){var d=0;for(var e in a.events){if(a.events[e].label==b&&a.events[e].startSample==c)return d;d++}return!1},resetSelection:function(a){for(var b=0;a>b;b++)this.uiInfo[b]=!1},round:function(a,b){(1>b||b>14)&&alert("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1==d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)}},EmuLabeller.LabFileParser={init:function(){this.ssr=44100},parseFile:function(a,b){var c=a.split("\n"),d=[];d.push({TierName:"Tier"+b,type:"seg",events:[]});var e=c[3].split(/\s+/);"H#"!=e[3]&&(d[d.length-1].type="point");for(var f=3;f<c.length;f++)e=c[f].split(/\s+/),d[d.length-1].events.push({label:e[3],time:e[1]*this.ssr});return d},toESPS:function(a){var b="";b=b+"signal "+emulabeller.curLoadedBaseName+"\n",b+="nfields 1\n#\n";var c=1;for(var d in a.events){var e=a.events[d],f=(e.startSample+e.sampleDur+1)/44100+1/44100/2;"seg"==a.type&&1==c?b=b+"	"+f+"	125	"+"H#"+"\n":c<a.events.length&&(b=b+"	"+f+"	125	"+e.label+"\n"),c+=1}return console.log(b),b}},EmuLabeller.TextGridParser={init:function(){this.l1='File type = "ooTextFile"',this.l2='Object class = "TextGrid"',this.ssr=44100},toJSO:function(a){a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g,"");var b,c,d,e,f=a.split("\n"),g=!0,h={origSamplerate:this.ssr,labelEncoding:"UTF-8",tiers:[]};if(f[0].replace(/\s+/g,"")==this.l1.replace(/\s+/g,"")&&f[1].replace(/\s+/g,"")==this.l2.replace(/\s+/g,"")){for(var i=2;i<f.length;i++){var j=f[i];"item[]:"!=j?g||(0===j.indexOf("item[")&&(b='"IntervalTier"'==f[i+1].split(/=/)[1]?"seg":"point",c=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers.push({TierName:c,type:b,events:[]})),h.tiers.length>0&&"seg"==h.tiers[h.tiers.length-1].type&&0===j.indexOf("intervals")&&0!==j.indexOf("intervals:")?(eSt=Math.ceil(f[i+1].split(/=/)[1]*this.ssr),eEt=Math.floor(f[i+2].split(/=/)[1]*this.ssr),e=f[i+3].split(/=/)[1].replace(/"/g,""),0===eSt&&(eSt+=1),h.tiers[h.tiers.length-1].events.push({label:e,startSample:eSt-1,sampleDur:eEt-eSt})):h.tiers.length>0&&"point"==h.tiers[h.tiers.length-1].type&&0===j.indexOf("points")&&0!==j.indexOf("points:")&&(d=f[i+1].split(/=/)[1]*this.ssr,e=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers[h.tiers.length-1].events.push({label:e,startSample:Math.round(d)}))):g=!1}return this.testForGapsInLabelJSO(h),h}alert("bad header in textgrid file!!! The header has to be: ",this.l1,"\n",this.l2)},toTextGrid:function(){var a=this,b="",c="\n",d="	";b=b+a.l1+c+a.l2+c+c,b=b+"xmin = "+a.findTimeOfMinSample()+c,b=b+"xmax = "+a.findTimeOfMaxSample()+c,b=b+"tiers? <exists>"+c,b=b+"size = "+emulabeller.tierHandler.getLength()+c,b=b+"item []:"+c;var e=0;return $("#cans div canvas").each(function(){var f=emulabeller.tierHandler.getTier($(this).attr("id"));e+=1,b=b+d+"item ["+e+"]:"+c,"seg"==f.type?b=b+d+d+'class = "IntervalTier"'+c:"point"==f.type&&(b=b+d+d+'class = "TextTier"'+c),b=b+d+d+'name = "'+f.TierName+'"'+c,b=b+d+d+"xmin = "+a.findTimeOfMinSample()+c,b=b+d+d+"xmax = "+a.findTimeOfMaxSample()+c,"seg"==f.type?b=b+d+d+"intervals: size = "+f.events.length+c:"point"==f.type&&(b=b+d+d+"points: size = "+f.events.length+c);for(var g=0;g<f.events.length;g++){var h=g+1;"seg"==f.type?(b=b+d+d+d+"intervals ["+h+"]:"+c,b=0!==f.events[g].startSample?b+d+d+d+d+"xmin = "+(f.events[g].startSample/a.ssr+1/a.ssr/2)+c:b+d+d+d+d+"xmin = "+0+c,b=g<f.events.length-1?b+d+d+d+d+"xmax = "+((f.events[g].startSample+f.events[g].sampleDur+1)/a.ssr+1/a.ssr/2)+c:b+d+d+d+d+"xmax = "+a.findTimeOfMaxSample()+c,b=b+d+d+d+d+'text = "'+f.events[g].label+'"'+c):"point"==f.type&&(b=b+d+d+d+"points["+h+"]:"+c,b=b+d+d+d+d+"time = "+f.events[g].startSample/a.ssr+c,b=b+d+d+d+d+'mark = "'+f.events[g].label+'"'+c)}}),b},findTimeOfMinSample:function(){return 0},findTimeOfMaxSample:function(){return emulabeller.viewPort.bufferLength/this.ssr},testForGapsInLabelJSO:function(a){for(var b=0,c=0;c<a.tiers.length;c++)if("seg"==a.tiers[c].type)for(var d=0;d<a.tiers[c].events.length-1;d++)a.tiers[c].events[d].startSample+a.tiers[c].events[d].sampleDur+1!=a.tiers[c].events[d+1].startSample&&(b+=1);console.log("TextGridParser had: ",b,"alignment issues found in parsed textgrid")}},EmuLabeller.SSFFparser={init:function(){this.ssffData={},this.ssffData.headID="SSFF -- (c) SHLRC\n",this.ssffData.machineID="Machine IBM-PC\n",this.ssffData.sepString="-----------------\n",this.ssffData.Record_Freq=-1,this.ssffData.Start_Time=-1,this.ssffData.Columns=[]},parseSSFF:function(a){var b=this,c=new Uint8Array(a),d=String.fromCharCode.apply(null,c),e=d.split(/^/m);(e[0]!=b.ssffData.headID||e[1]!=b.ssffData.machineID)&&alert("no ssff file... or missing fields"),"Record_Freq "!=e[2].split(/[ ,]+/)[0]||"Start_Time "!=e[3].split(/[ ,]+/)[0]?(this.ssffData.Record_Freq=e[2].split(/[ ,]+/)[1],this.ssffData.Start_Time=e[3].split(/[ ,]+/)[1]):alert("no ssff file... or missing fields ");for(var f=4;f<e.length&&e[f]!=this.ssffData.sepString;f++){var g=e[f].split(/[ ]+/);"Column"==g[0]&&this.ssffData.Columns.push({name:g[1],type:g[2],length:g[3],values:[]})}var h=e.slice(0,f+1).join("").length;console.log(c[h]);for(var i,j,k;h<=c.length;)for(f=0;f<this.ssffData.Columns.length;f++)"DOUBLE"==this.ssffData.Columns[f].type?(k=8*this.ssffData.Columns[f].length,j=a.subarray(h,k),i=new Float64Array(j),this.ssffData.Columns[f].values.push(i),h+=k):"FLOAT"==this.ssffData.Columns[f].type?(k=4*this.ssffData.Columns[f].length,j=a.subarray(h,k),i=new Float32Array(j),this.ssffData.Columns[f].values.push(i),h+=k):alert("not supported... only doubles for now");return this.ssffData},load:function(a){var b=new XMLHttpRequest;b.responseType="arraybuffer",b.addEventListener("load",function(a){emulabeller.newFileType=2,emulabeller.parseNewFile(a.target.response)},!1),b.open("GET",a,!0),b.send()}},ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},EmuLabeller.JSONvalidator={init:function(){this.successObj={foo:"bar"},this.failureObj={f:1234},this.schema={$schema:"http://json-schema.org/draft-03/schema#",title:"tierInfos",description:"JSON representation of tier information containing sample times of events with label information",type:"object",properties:{origSamplerate:{description:"sample rate of audio file that this JSON contains the label information of",type:"integer"},labelEncoding:{description:"encoding of labels given. Only UTF-8 is supported. So anything else will not work",type:"string"},tiers:{description:"array containing tier information of multiple tiers",type:"array",items:{type:"object",properties:{tierName:{description:"name of tier which should uniquely specify the tier from others in view",type:"string"},tierType:{description:"type of tier can either be 'seg' to mark a segment tier or 'point' to mark a point/event tier",type:{"enum":["seg","point"]}},events:{description:"array containing containing label information of multiple labels",type:"array",items:{type:"object",properties:{label:{description:"an arbitrary UTF-8 string that describes the label",type:"string"},atSample:{description:"sample that marks the start/point of the event dependent on the type of tier",type:"integer"},dur:{description:"duration of segment (in tierType seg) where atSample+dur marks the end sample of the segment",type:"integer"}}}}},required:["tierName","tierType","events"],additionalProperties:!1}}},required:["origSamplerate","labelEncoding"],additionalProperties:!1}},validateTierInfos:function(){var a=JSV.createEnvironment("json-schema-draft-03");this.successObj;var b=a.validate("{foo:'bar‘}",this.schema);if(console.log(b),console.log(this.failureObj),0===b.errors.length)console.log("Object is valid! Length of errors: "+b.errors.length);else{var c=b.errors;console.log("uri : "+c[0].uri+"\nmessage :  "+c[0].message)}}};var Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(a){var b=3*(a.length/4),c=new ArrayBuffer(b);return this.decode(a,c),c},decode:function(a,b){var c=this._keyStr.indexOf(a.charAt(a.length-1)),d=this._keyStr.indexOf(a.charAt(a.length-2)),e=3*(a.length/4);64==c&&e--,64==d&&e--;var f,g,h,i,j,k,l,m,n=0,o=0;for(f=b?new Uint8Array(b):new Uint8Array(e),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),n=0;e>n;n+=3)j=this._keyStr.indexOf(a.charAt(o++)),k=this._keyStr.indexOf(a.charAt(o++)),l=this._keyStr.indexOf(a.charAt(o++)),m=this._keyStr.indexOf(a.charAt(o++)),g=j<<2|k>>4,h=(15&k)<<4|l>>2,i=(3&l)<<6|m,f[n]=g,64!=l&&(f[n+1]=h),64!=m&&(f[n+2]=i);return f}};sIOrequest=function(a){this.PROTOCOL="emu",this.CMD_REQ_UTTERANCES="req_utterances",this.protocol=this.PROTOCOL,this.cmd=a},EmuLabeller.socketIOhandler={init:function(){my=this,console.log("init sockets"),this.DEFAULT_WS_URI="ws://localhost:7681/",this.wsUri=this.DEFAULT_WS_URI,this.retryInterval=1e4;var a=$("#cmd_disconnect");a.css("display","inline"),a.css("visibility","visible"),a.attr("disabled","disabled")},onConnect:function(a){this.connectHandler=a},onUtteranceList:function(a){this.utteranceListHandler=a},onDataLoad:function(a){this.dataLoadHandler=a},onDisconnect:function(a){this.disconnectHandler=a},startTryConnect:function(){var a=this,b=$("#startupDialog");b.css("top","50%"),b.css("opacity","1"),b.css("visibility","visible"),$("#cmd_cancelWebsocketWait").click(function(){a.stopTryConnect(),a.hideModalDialog()}),this.connect()},hideModalDialog:function(){var a=$("#startupDialog");a.css("top","50%"),a.css("opacity","0"),a.css("visibility","hidden")},stopTryConnect:function(){window.clearTimeout(this.retryId),this.hideModalDialog()},connect:function(){var a=this;websocket=new WebSocket(a.wsUri),websocket.onopen=function(b){a.onOpen(b)},websocket.onclose=function(b){a.onClose(b)},websocket.onmessage=function(b){a.onMessage(b)},websocket.onerror=function(b){a.onError(b)},console.log("try connect sockets");var b=$("#cmd_disconnect");b.attr("disabled","disabled")},requestDisconnect:function(){var a=new sIOrequest("disconnect");this.sendRequest(a)},onOpen:function(a){console.log("ON OPEN"),this.stopTryConnect(),this.connectHandler&&this.connectHandler(a),$("#cmd_disconnect").removeAttr("disabled");var b=new sIOrequest("req_utterances");this.sendRequest(b)},onClose:function(a){$("#cmd_disconnect").attr("disabled","disabled"),this.disconnectHandler&&this.disconnectHandler(a),console.log("ON CLOSE"),my.retryId=window.setTimeout(function(a){return function(){a.connect()}}(my),my.retryInterval)},onMessage:function(a){var b=typeof a.data;if("string"===b){console.log("ON MESSAGE");var c=JSON.parse(a.data),d=c.responseContent;if("utterance_list"===d){var e=c.data;console.log("Received utterance list:\n",e),this.utteranceListHandler&&this.utteranceListHandler(e)}else if("audio"===d){var f=Base64Binary.decodeArrayBuffer(c.data);this.dataLoadHandler(0,f)}}else console.log("ON MESSAGE with binary message (ERROR we do not use binary wrbsocket mode)")},onError:function(a){console.log("ON ERROR",a)},doSend:function(a){websocket.send(a)},sendRequest:function(a){var b=JSON.stringify(a);console.log("Sending: "+b),this.doSend(b)},loadUtterance:function(a){var b=new sIOrequest("req_audio");b.code=a,this.sendRequest(b)}},EmuLabeller.IOhandler={init:function(a,b){var c=this;this.externalMode=b,this.textGridHandler=Object.create(EmuLabeller.TextGridParser),this.textGridHandler.init(),this.labFileHandler=Object.create(EmuLabeller.LabFileParser),this.labFileHandler.init(),this.DropBoxHandler=Object.create(EmuLabeller.DropBoxHandler),this.fileNames={audio:[],label:[],SSFF:[]},0==b.value&&(this.socketIOhandler=Object.create(EmuLabeller.socketIOhandler),this.socketIOhandler.init(),this.socketIOhandler.onConnect(function(a){c.websocketConnected(a)}),this.socketIOhandler.onDataLoad(function(a,b){c.dataLoaded(a,b)}),this.socketIOhandler.onDisconnect(function(a){c.websocketDisconnected(a)}))},start:function(){0==this.externalMode.value?this.socketIOhandler.startTryConnect():this.connectEventHandler(evt)},websocketConnected:function(a){this.connectEventHandler&&this.connectEventHandler(a)},onConnected:function(a){this.connectEventHandler=a},onUtteranceList:function(a){this.socketIOhandler.onUtteranceList(a)},onDisconnected:function(a){this.disconnectEventHandler=a},websocketLoad:function(a){this.socketIOhandler.loadUtterance(a)},dataLoaded:function(a,b){emulabeller.newFileType=a,emulabeller.parseNewFile(b)},websocketSave:function(){console.log("supposed to save stuff to websocket! Websockets not implemented yet")},websocketDisconnected:function(a){this.disconnectEventHandler&&this.disconnectEventHandler(a)},disconnect:function(){0===this.externalMode.value&&this.socketIOhandler.requestDisconnect()},xhrLoad:function(a,b,c){var d=new XMLHttpRequest,e=a.split(/\//)[a.split(/\//).length-1];d.responseType=b,0===c?(this.fileNames.audio=[],this.fileNames.audio.push(e)):3==c&&(this.fileNames.label=[],this.fileNames.label.push(e)),d.addEventListener("load",function(a){emulabeller.newFileType=c,emulabeller.parseNewFile(a.target.response),0===c&&(emulabeller.curLoadedBaseName=e.split(/\./)[0])},!1),d.open("GET",a,!0),d.send()},parseTextGrid:function(a){return res=this.textGridHandler.toJSO(a,this.fileNames.label[this.fileNames.label.length-1])},toTextGrid:function(a){return res=this.textGridHandler.toTextGrid(a)},toESPS:function(a){return res=this.labFileHandler.toESPS(a)},dropBoxOpen:function(){this.DropBoxHandler.openDropBox()}},EmuLabeller.tierHandler={init:function(a){this.internalCanvasWidth=a.internalCanvasWidth,this.internalCanvasHeightSmall=a.internalCanvasHeightSmall,this.internalCanvasHeightBig=a.internalCanvasHeightBig,this.tierInfos=a.tierInfos,this.iconImageSize=12,this.isSelected=!1,this.isEditing=!1,this.exportData=null,this.lastSample=0,this.myHistoryCounter=0,this.myHistory={},this.editAreaTextfieldName="editArea",this.tierCssName="tierSettings",this.historyEndError="Cannot go back, no more history saved.... &#9785;",this.commonError="Error: It is not allowed to insert a segment here!",this.pointExistsError="Error: This point already exists !",this.noTierError="Error: No Tier chosen !",this.pointSegmentError="Error: Points may not be inserted on a Segment Tier!",this.reallyDeleteMsg="Really delete ",this.params=a,this.isWaveSpecZoomMode=!1,$("#downDialog").dialog({dialogClass:"myPopup",bgiframe:!0,modal:!0,autoOpen:!1,width:500,height:500,show:{effect:"fade",duration:175},hide:{effect:"fade",duration:175},position:"center",buttons:{Download:function(){emulabeller.tierHandler.doDownload(),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},open:function(){emulabeller.internalMode=emulabeller.EDITMODE.MODAL,window.onscroll=function(){window.scrollTo(0,0)}},beforeClose:function(){emulabeller.internalMode=emulabeller.EDITMODE.STANDARD,window.onscroll=function(){}}})},reinit:function(){this.myHistory={},this.tierInfos={tiers:[],canvases:[]},$("#cans").empty()},history:function(){this.myHistory[this.myHistoryCounter]=jQuery.extend(!0,{},this.tierInfos),++this.myHistoryCounter},goBackHistory:function(){this.myHistoryCounter-1>0?(delete this.tierInfos,this.tierInfos=jQuery.extend(!0,{},this.myHistory[this.myHistoryCounter-2]),--this.myHistoryCounter,this.rebuildTiers(),emulabeller.drawBuffer()):emulabeller.alertUser("Error",this.historyEndError)},addTier:function(a){var b="Tier"+(this.getLength()+1);if(a)var c={TierName:b,type:"point",events:[]};else{var c={TierName:b,type:"seg",events:[]};c.events.push({label:"",startSample:1,sampleDur:emulabeller.backend.currentBuffer.length-1})}this.addTiertoHtml(b,this.tierCssName,"#"+this.params.cans.id),this.tierInfos.tiers[b]=c,this.history(),emulabeller.drawer.updateSingleTier(this.tierInfos.tiers[b])},addLoadedTiers:function(a){var b=this;$.each(a.tiers,function(){b.addTiertoHtml(this.TierName,b.tierCssName,"#"+b.params.cans.id),b.tierInfos.tiers[this.TierName]=this}),this.history()},getLength:function(){var a=0,b=this.tierInfos.tiers;for(var c in b)a++;return a},getCanvas:function(a){return $("#"+a)[0]},getCanvasContext:function(a){return this.getCanvas(a).getContext("2d")},addTiertoHtml:function(a,b,c){var d="<div class='tierButtons'><a href='#' id='"+a+"_del' class='deleteButton'><img/></a><a href='#' id='"+a+"_res' class='resizeButton'><img/></a><a href='#' id='"+a+"_save' class='saveSingleTierBtn'><img/></a></div>",e=$("<canvas>").attr({id:a,width:this.internalCanvasWidth,height:this.internalCanvasHeightSmall}).addClass(b).add(d);$('<div class="hull'+a+'" style="position:relative;">').attr({id:"hull"+a}).html(e).appendTo(c),$("#"+a).bind("click",function(a){emulabeller.tierHandler.handleTierClick(emulabeller.getX(a.originalEvent),emulabeller.getY(a.originalEvent),emulabeller.tierHandler.getTier(emulabeller.getTierName(a.originalEvent)))}),$("#"+a+"_del").bind("click",function(){var a=$(this).parent().prev().get(0).id;emulabeller.confirmUser("Delete",emulabeller.tierHandler.reallyDeleteMsg+"'"+a+"' ?",emulabeller.tierHandler.removeTier,a)}),$("#"+a+"_res").bind("click",function(){var a=$(this).parent().prev().get(0).id;emulabeller.tierHandler.resizeTier(a)}),$("#"+a+"_save").bind("click",function(){var a=emulabeller.curLoadedBaseName+"."+$(this).parent().prev().get(0).id,b=emulabeller.LabFileParser.toESPS(emulabeller.tierHandler.getTier($(this).parent().prev().get(0).id));emulabeller.tierHandler.downloadDialog(a,b)}),$("#"+a).bind("dblclick",function(a){emulabeller.tierHandler.handleTierDoubleClick(emulabeller.getX(a.originalEvent))}),$("#"+a).bind("contextmenu",function(a){emulabeller.tierHandler.handleTierClickMulti(emulabeller.getX(a.originalEvent),emulabeller.getY(a.originalEvent),emulabeller.tierHandler.getTier(this.id))}),$("#"+a).bind("mousemove",function(a){curSample=emulabeller.viewPort.getCurrentSample(emulabeller.getX(a.originalEvent)),emulabeller.tierHandler.isSelected&&a.shiftKey?(emulabeller.internalMode=emulabeller.EDITMODE.LABEL_RESIZE,emulabeller.tierHandler.removeLabelDoubleClick(),emulabeller.tierHandler.moveBoundary(curSample,emulabeller.getTierName(a.originalEvent)),emulabeller.drawer.uiDrawUpdate()):emulabeller.tierHandler.isSelected&&a.altKey?(emulabeller.internalMode=emulabeller.EDITMODE.LABEL_MOVE,emulabeller.tierHandler.removeLabelDoubleClick(),emulabeller.tierHandler.moveSegment(curSample,emulabeller.getTierName(a.originalEvent)),emulabeller.drawer.uiDrawUpdate()):emulabeller.tierHandler.trackMouseInTiers(a,emulabeller.getX(a.originalEvent),emulabeller.getY(a.originalEvent),emulabeller.getTierName(a.originalEvent)),emulabeller.tierHandler.lastSample=curSample
}),$("#"+a).bind("mouseout",function(a){emulabeller.tierHandler.isSelected=!1,emulabeller.viewPort.curMouseMoveTierName="",emulabeller.viewPort.curMouseMoveSegmentName="",emulabeller.viewPort.curMouseMoveSegmentStart="",emulabeller.viewPort.curMouseMoveSegmentDuration="",emulabeller.drawer.updateSingleTier(emulabeller.tierHandler.getTier(emulabeller.getTierName(a.originalEvent)))}),$("#"+a).bind("mouseup",function(){}),$("#"+a).bind("mousedown",function(){}),$("#"+a).bind("mouseout",function(){})},trackMouseInTiers:function(a,b,c,d){if(!this.isEditing){var e=this.getTier(d),f=emulabeller.viewPort.sS+(emulabeller.viewPort.eS-emulabeller.viewPort.sS)*b,a=this.findAndMarkNearestSegmentBoundry(e,f);null!=a&&(emulabeller.viewPort.curMouseMoveTierName=e.TierName,emulabeller.viewPort.curMouseMoveSegmentName=emulabeller.viewPort.getId(e,a.label,a.startSample),emulabeller.viewPort.curMouseMoveSegmentStart=a.startSample,emulabeller.viewPort.curMouseMoveSegmentDuration=a.sampleDur,emulabeller.tierHandler.isSelected=!0),$("*").css("cursor","auto"),emulabeller.drawer.updateSingleTier(e,b,c)}},findAndMarkNearestSegmentBoundry:function(a,b){var c=null,d=null,e=a.events;for(var f in e)(null===c||Math.abs(e[f].startSample-b)<Math.abs(c-b))&&(c=e[f].startSample,d=e[f]);return d},rebuildTiers:function(){for(t in this.tierInfos.tiers)this.removeTierHtml(this.tierInfos.tiers[t].TierName),null==document.getElementById(this.tierInfos.tiers[t].TierName)&&this.addTiertoHtml(this.tierInfos.tiers[t].TierName,this.tierCssName,"#"+this.params.cans.id)},removeTierHtml:function(a){$("#"+a).remove(),$("#"+a+"_del").remove(),$("#"+a+"_res").remove()},removeTier:function(a){emulabeller.tierHandler.removeTierHtml(a),delete emulabeller.tierHandler.tierInfos.tiers[a],emulabeller.tierHandler.history()},removeSegment:function(a,b,c){var d=emulabeller.viewPort.getId(a,b,c),e=this.tierInfos.tiers[a.TierName].events[d].sampleDur/2;delete this.tierInfos.tiers[a.TierName].events[d],null==this.tierInfos.tiers[a.TierName].events[d-1]?(this.tierInfos.tiers[a.TierName].events[d+1].sampleDur+=2*e,this.tierInfos.tiers[a.TierName].events[d+1].startSample-=2*e):null==this.tierInfos.tiers[a.TierName].events[d+1]?this.tierInfos.tiers[a.TierName].events[d-1].sampleDur+=2*e:(this.tierInfos.tiers[a.TierName].events[d-1].sampleDur+=e,this.tierInfos.tiers[a.TierName].events[d+1].sampleDur+=e,this.tierInfos.tiers[a.TierName].events[d+1].startSample-=e),a.events.sort(function(a,b){return parseFloat(a.startSample)-parseFloat(b.startSample)})},removePoint:function(a,b,c){for(s in this.tierInfos.tiers[a.TierName].events)this.tierInfos.tiers[a.TierName].events[s].label==b&&this.tierInfos.tiers[a.TierName].events[s].startSample==c&&(console.log(this.tierInfos.tiers[a.TierName].events[s]),delete this.tierInfos.tiers[a.TierName].events[s])},deleteSelected:function(){var a=emulabeller.viewPort.getAllSelected(emulabeller.tierHandler.getSelectedTier()),b=emulabeller.tierHandler.reallyDeleteMsg;for(s in a)b+=a[s].label+", ";emulabeller.confirmUser("Delete",b.substring(0,b.length-2)+" ?",emulabeller.tierHandler.subDeleteSelected,a)},subDeleteSelected:function(a){var b=emulabeller.tierHandler.getSelectedTier();for(s in a)"seg"==b.type&&emulabeller.tierHandler.removeSegment(b,a[s].label,a[s].startSample),"point"==b.type&&emulabeller.tierHandler.removePoint(b,a[s].label,a[s].startSample);b.events.sort(function(a,b){return parseFloat(a.startSample)-parseFloat(b.startSample)}),emulabeller.tierHandler.history(),emulabeller.drawBuffer()},downloadDialog:function(a,b){return this.exportData=b,window.scrollTo(0,0),$("#downDialog").dialog("option","position",["center",10]),$("#downDialog").dialog("option","title","Download "+a),$("#saveAsFileName").val(a),$("#preview").html(b),$("#downDialog").dialog("open"),!1},SaveToDisk:function(a,b){if(!window.ActiveXObject){var c=document.createElement("a");c.href=a,c.target="_blank",c.download=b||"unknown";var d=document.createEvent("Event");d.initEvent("click",!0,!0),c.dispatchEvent(d)}},doDownload:function(){var a=this.exportData,b=$("#saveAsFileName").val();if(!window.ActiveXObject){null!=f&&(window.URL||window.webkitURL).revokeObjectURL(f.href);try{var c=new Blob([a],{type:"text/plain;charset=UTF-8"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,c.append(a),c=c.getBlob()}window.URL=window.URL||window.webkitURL;var e=window.URL.createObjectURL(c),f=document.createElement("a");f.href=e,f.target="_blank",f.download=b||"unknown";var g=document.createEvent("MouseEvents");g.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),f.dispatchEvent(g),f.remove(),e=null}return!1},deleteBorder:function(){if(""!=emulabeller.viewPort.curMouseMoveTierName){var a=this.getTier(emulabeller.viewPort.curMouseMoveTierName),b=this.tierInfos.tiers[a.TierName].events[emulabeller.viewPort.curMouseMoveSegmentName],c=emulabeller.tierHandler.previousEvent(a,b.startSample),d=this.reallyDeleteMsg+"border between "+c.label+" and "+b.label+" (Sample "+b.startSample+") ?";emulabeller.confirmUser("Remove Border",d+" ?",emulabeller.tierHandler.subDeleteBorder,[a,b,c])}else emulabeller.alertUser("Error","Please select a boundary first!")},subDeleteBorder:function(a){var b=a[0],c=a[1],d=a[2];if(null!=d){d.sampleDur+=c.sampleDur,d.label+=c.label;var e=emulabeller.viewPort.getId(b,c.label,c.startSample);delete emulabeller.tierHandler.tierInfos.tiers[b.TierName].events[e],b.events.sort(function(a,b){return parseFloat(a.startSample)-parseFloat(b.startSample)}),emulabeller.tierHandler.history(),emulabeller.drawBuffer()}},resizeSpectroWave:function(a){var b=this.internalCanvasHeightBig/2,c=$("#wave").height()+$("#spectrogram").height(),d=c-b;this.isWaveSpecZoomMode?($("#spectrogram").height(c/2+"px"),$("#wave").height(c/2+"px"),this.isWaveSpecZoomMode=!1):a?($("#wave").height(b+"px"),$("#spectrogram").height(d+"px"),this.isWaveSpecZoomMode=!0):($("#spectrogram").height(b+"px"),$("#wave").height(d+"px"),this.isWaveSpecZoomMode=!0)},resizeTier:function(a){var b=this.internalCanvasHeightBig-1;$("#"+a).height()>=b?($("#"+a+"_del").hide(),$("#"+a+"_save").hide(),$("#"+a).height($("#"+a+"_del").height()-3+"px")):($("#"+a).height(this.internalCanvasHeightBig),$("#"+a+"_del").show(),$("#"+a+"_save").show())},selectSegmentsUnderSelection:function(){var a=this.getSelectedTier();if(null!=a)if("seg"==a.type){emulabeller.viewPort.resetSelection(a.events.length),emulabeller.viewPort.setSelectTier(a.TierName),this.removeLabelDoubleClick();var b=emulabeller.tierHandler.getCanvas(a.TierName),c=a.events,d=0,e=emulabeller.viewPort.eS,f=emulabeller.viewPort.sS;for(var g in c)c[g].startSample>=emulabeller.viewPort.selectS&&c[g].startSample+c[g].sampleDur<=emulabeller.viewPort.selectE&&(++d,c[g].startSample<=e&&(e=c[g].startSample),c[g].startSample+c[g].sampleDur>=f&&(f=c[g].startSample+c[g].sampleDur),emulabeller.viewPort.setSelectMultiSegment(a,c[g],!0,b.width,!0));0==d?emulabeller.alertUser("Error","There were no segments under your selection!"):emulabeller.viewPort.resizeSelectArea(e,f),emulabeller.drawBuffer()}else"point"==a.type;else emulabeller.alertUser("Error","Please select a Tier first!")},handleTierClick:function(a,b,c){emulabeller.viewPort.resetSelection(c.events.length),emulabeller.viewPort.setSelectTier(c.TierName),this.removeLabelDoubleClick();var d=emulabeller.tierHandler.getCanvas(c.TierName);if(emulabeller.tierHandler.getCanvasContext(c.TierName),"seg"==c.type){var e=this.nearestSegment(c,emulabeller.viewPort.getCurrentSample(a));null!=e&&(emulabeller.viewPort.curMouseMoveTierName=e.label,emulabeller.viewPort.curMouseMoveTierType=c.type,emulabeller.viewPort.curMouseMoveSegmentName=emulabeller.viewPort.getId(c,e.label,e.startSample),emulabeller.viewPort.curMouseMoveSegmentStart=e.startSample,emulabeller.viewPort.curMouseMoveSegmentDuration=e.sampleDur,emulabeller.viewPort.setSelectSegment(c,e,!0,d.width))}if("point"==c.type){var e=this.nearestEvent(c,emulabeller.viewPort.getCurrentSample(a));null!=e&&(emulabeller.viewPort.curMouseMoveTierName=e.label,emulabeller.viewPort.curMouseMoveTierType=c.type,emulabeller.viewPort.curMouseMoveSegmentName=emulabeller.viewPort.getId(c,e.label,e.startSample),emulabeller.viewPort.curMouseMoveSegmentStart=e.startSample,emulabeller.viewPort.curMouseMoveSegmentDuration=e.sampleDur,emulabeller.viewPort.setSelectPoint(c,e,!0,d.width))}emulabeller.drawBuffer()},handleTierClickMulti:function(a,b,c){emulabeller.viewPort.getSelectTier()!=c.TierName&&(emulabeller.viewPort.setSelectTier(c.TierName),emulabeller.viewPort.resetSelection(c.events.length)),this.removeLabelDoubleClick();var d=emulabeller.tierHandler.getCanvas(c.TierName);if(emulabeller.tierHandler.getCanvasContext(c.TierName),"seg"==c.type){var e=this.nearestSegment(c,emulabeller.viewPort.getCurrentSample(a));null!=e&&(emulabeller.viewPort.curMouseMoveTierName=event.label,emulabeller.viewPort.curMouseMoveSegmentName=emulabeller.viewPort.getId(c,event.label,event.startSample),emulabeller.viewPort.MouseSegmentName=emulabeller.viewPort.getId(c,event.label,event.startSample),emulabeller.viewPort.curMouseMoveSegmentStart=event.startSample,emulabeller.viewPort.curMouseMoveSegmentDuration=event.sampleDur,0==emulabeller.viewPort.setSelectMultiSegment(c,e,!0,d.width)&&this.handleTierClick(a,b,c))}emulabeller.drawBuffer()},handleTierDoubleClick:function(a){var b=this;tierDetails=this.getSelectedTier(),emulabeller.viewPort.setSelectTier(tierDetails.TierName),emulabeller.viewPort.resetSelection(tierDetails.events.length);var c=emulabeller.tierHandler.getCanvas(tierDetails.TierName);emulabeller.tierHandler.getCanvasContext(tierDetails.TierName);var d=$("#"+this.editAreaTextfieldName);if(0===d.length){if(emulabeller.tierHandler.isEditing=!0,"seg"==tierDetails.type){if(a)var e=this.nearestSegment(tierDetails,emulabeller.viewPort.getCurrentSample(a));if(null!=e){emulabeller.viewPort.setSelectSegment(tierDetails,e,!0,c.width);var f=emulabeller.viewPort.getPos(c.clientWidth,emulabeller.viewPort.selectS),g=emulabeller.viewPort.getPos(c.clientWidth,emulabeller.viewPort.selectE);this.createEditArea(tierDetails.TierName,f,0,g-f-5,c.height/2-5,e.label,c,!0)}}else if("point"==tierDetails.type){var e=this.nearestEvent(tierDetails,emulabeller.viewPort.getCurrentSample(a));emulabeller.viewPort.setSelectSegment(tierDetails,e,!0,c.width),emulabeller.viewPort.select(e.startSample,e.startSample);var f=emulabeller.viewPort.getPos(c.clientWidth,emulabeller.viewPort.selectS),h=45;this.createEditArea(tierDetails.TierName,f-(h-5)/2,c.height/8,h-5,c.height/4-5,e.label,c,!0)}}else b.removeLabelDoubleClick();emulabeller.drawBuffer()},nearestSegment:function(a,b){var c=a.events,d=null,e=emulabeller.tierHandler.getCanvas(a.TierName),f=emulabeller.viewPort.getSampleDist(e.width),g=Math.round(b),h=g+f,i=g;console.log(f+" "+g+" "+i);for(var j in c)0==c[j].sampleDur?(h==c[j].startSample||i==c[j].startSample)&&(d=c[j]):g>=c[j].startSample&&g<=c[j].startSample+c[j].sampleDur&&(d=c[j]);return d},tierExists:function(a){var b=this.tierInfos.tiers;for(var c in b)if(b[c].TierName==a)return!0;return!1},nearestEvent:function(a,b){var c=a.events,d=null,e=emulabeller.viewPort.eS;for(var f in c){var g=Math.abs(b-c[f].startSample);e>g&&(e=g,d=c[f])}return console.log(d.startSample),console.log(g),d},nextEvent:function(a,b){var c=a.events,d=null,e=0;for(var f in c){var g=b-c[f].startSample;g>=e&&g>=0&&g<=c[f].sampleDur&&(e=g,d=c[f])}return d},previousEvent:function(a,b){var c=a.events,d=null;for(var e in c){if(c[e].startSample==b)return d;d=c[e]}return null},getSelectedTier:function(){return this.tierInfos.tiers[emulabeller.viewPort.getSelectTier()]},getSelectedTierType:function(){return null==this.tierInfos.tiers[emulabeller.viewPort.getSelectTier()]?!1:this.tierInfos.tiers[emulabeller.viewPort.getSelectTier()].type},getTiers:function(){return this.tierInfos.tiers},getTier:function(a){return this.tierInfos.tiers[a]},createEditArea:function(a,b,c,d,e,f,g){var h=Math.round(b)+g.offsetLeft+2,i=g.offsetTop+2+c,j=d,k=e,l=$("<textarea>").attr({id:"editing"}).css({top:i+"px",left:h+"px",width:j+"px",height:k+"px"}).addClass(this.editAreaTextfieldName).text(f);$("#hull"+a).prepend(l),this.createSelection(document.getElementById("editing"),0,f.length),emulabeller.internalMode=emulabeller.EDITMODE.LABEL_RENAME},createSelection:function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},saveLabelName:function(){var a=this.getSelectedTier(),b=$("#editing").val();a.events[emulabeller.viewPort.getSelectName()].label=b.replace(/[\n\r]/g,""),emulabeller.drawer.updateSingleTier(a),this.history()},saveTierName:function(){var a=this,b=this.getSelectedTier(),c=b.TierName,d=$("#editing").val().replace(/[\n\r]/g,"");if(this.tierExists(d))emulabeller.alertUser("Error","A tier with this name ('"+d+"') already exists!");else{var e=jQuery.extend(!0,{},b);delete this.tierInfos.tiers[c],$("#"+c).attr("id",d),a.tierInfos.tiers[d]=e,a.tierInfos.tiers[d].TierName=d,emulabeller.drawBuffer(),this.history()}},renameTier:function(){var a=this.getSelectedTier();if(null!=a){var b=emulabeller.tierHandler.getCanvas(a.TierName),c=emulabeller.viewPort.getPos(b.clientWidth,0);this.createEditArea(a.TierName,0,c,b.clientWidth-5,b.height/2-5,a.TierName,b,!1)}else emulabeller.alertUser("Error","Please mark a tier first...")},addBorder:function(a,b,c){var d=c-b.startSample,e=b.sampleDur-d;b.sampleDur=d-1,a.events.push({label:"",startSample:Math.round(c),sampleDur:Math.round(e)}),a.events.sort(function(a,b){return parseFloat(a.startSample)-parseFloat(b.startSample)}),this.history()},addSegment:function(a,b,c,d){var e=c-b.startSample,f=b.sampleDur-e,g=d-c;b.sampleDur=e-1,a.events.push({label:"",startSample:c,sampleDur:g-1}),a.events.push({label:"",startSample:d,sampleDur:f-g}),a.events.sort(function(a,b){return parseFloat(a.startSample)-parseFloat(b.startSample)}),this.history()},addSegmentAtSelection:function(){var a=this.getSelectedTier();if(null!=a){if("seg"==a.type){var b=this.nextEvent(a,emulabeller.viewPort.selectS),c=this.nextEvent(a,emulabeller.viewPort.selectE);if(b==c)emulabeller.viewPort.selectS==emulabeller.viewPort.selectE?null!=b?this.addBorder(a,b,emulabeller.viewPort.selectS):emulabeller.alertUser("Error",this.commonError):this.addSegment(a,b,emulabeller.viewPort.selectS,emulabeller.viewPort.selectE);else{var d=emulabeller.viewPort.getCurrentPercent(emulabeller.viewPort.selectS);this.handleTierDoubleClick(d)}}else if(a.type="point")if(emulabeller.viewPort.selectS==emulabeller.viewPort.selectE){var e=this.nearestEvent(a,emulabeller.viewPort.selectS);null==e||e.startSample!=emulabeller.viewPort.selectS?(a.events.push({label:"newPoint",startSample:emulabeller.viewPort.selectS,sampleDur:0}),a.events.sort(function(a,b){return parseFloat(a.startSample)-parseFloat(b.startSample)})):emulabeller.alertUser("Error",this.pointExistsError)}else emulabeller.alertUser("Error",this.pointSegmentError);emulabeller.drawBuffer()}else emulabeller.alertUser("Error",this.noTierError)},removeLabelDoubleClick:function(){$("."+this.editAreaTextfieldName).remove(),emulabeller.tierHandler.isEditing=!1},moveBoundary:function(a,b){if(a=Math.round(a),null!=this.tierInfos.tiers[b]){var c=this.tierInfos.tiers[b].events[emulabeller.viewPort.curMouseMoveSegmentName-1],d=this.tierInfos.tiers[b].events[emulabeller.viewPort.curMouseMoveSegmentName],e=this.tierInfos.tiers[b].events[emulabeller.viewPort.curMouseMoveSegmentName+1];if("seg"==this.tierInfos.tiers[b].type){var f=d.startSample;null!=c&&null!=e?a>c.startSample&&a<e.startSample&&(d.startSample=a,d.sampleDur-=a-f,c.sampleDur+=a-f):null!=c?a>c.startSample&&a<emulabeller.viewPort.eS-20&&(c.sampleDur+=a-f,d.startSample=a,d.sampleDur-=a-f):null!=e&&a>emulabeller.viewPort.sS+20&&a<e.startSample&&(d.startSample=a,d.sampleDur-=a-f)}else oldTime=d.startSample,null!=c&&null!=e?a>c.startSample&&a<e.startSample&&(d.startSample=a):null!=c?a>c.startSample&&a<emulabeller.viewPort.eS-20&&(c.sampleDur+=a-f,d.startSample=a,d.sampleDur-=a-f):null!=e&&a>emulabeller.viewPort.sS+20&&a<e.startSample&&(d.startSample=a,d.sampleDur-=a-f);emulabeller.viewPort.selectMove(this.tierInfos.tiers[b],d),emulabeller.viewPort.select(d.startSample,d.startSample)}},moveSegment:function(a,b){changeTime=Math.round(a-this.lastSample);var c=this.tierInfos.tiers[b],d=!1,e=!0,f=0,g=0,h=emulabeller.viewPort.countSelected();if(null!=c){for(var i=emulabeller.viewPort.getAllSelected(c),j=0;j<i.length;j++)null!=i[j]&&(e&&(null==c.events[j+h+1]?null==c.events[j+h]?c.events[j].startSample+changeTime>c.events[j-1].startSample&&c.events[j+h-1].startSample+c.events[j+h-1].sampleDur+changeTime<emulabeller.viewPort.eS-1:c.events[j].startSample+changeTime>c.events[j-1].startSample&&c.events[j+h-1].startSample+c.events[j+h-1].sampleDur+changeTime<=emulabeller.viewPort.eS-1&&(d=!0,c.events[j-1].sampleDur+=changeTime):null==c.events[j-1]?c.events[j].startSample+changeTime>emulabeller.viewPort.sS&&c.events[j+h-1].startSample+c.events[j+h-1].sampleDur+changeTime<c.events[j+h+1].startSample-1:c.events[j].startSample+changeTime>c.events[j-1].startSample&&c.events[j+h-1].startSample+c.events[j+h-1].sampleDur+changeTime<=c.events[j+h+1].startSample-1&&(d=!0,c.events[j-1].sampleDur+=changeTime),g=j,e=!1),f=j+1,d&&(c.events[j].startSample+=changeTime));d&&null!=c.events[f]&&(c.events[f].startSample+=changeTime,c.events[f].sampleDur-=changeTime,emulabeller.viewPort.select(c.events[g].startSample,c.events[f].startSample))}},getNeighboringTier:function(a,b,c){var d;if(b?(d=$("#hull"+a).prev().attr("id"),!d&&c&&emulabeller.alertUser("Error","no tier above the selected boundary!")):(d=$("#hull"+a).next().attr("id"),!d&&c&&emulabeller.alertUser("Error","no tier below the selected boundary!")),d)var e=d.replace(/hull/g,"");return this.getTier(e)},snapSelectedBoundaryToNearestTopOrBottom:function(a){if(emulabeller.internalMode==emulabeller.EDITMODE.STANDARD){var b=this.getNeighboringTier(emulabeller.viewPort.curMouseMoveTierName,a,!0),c=this.nearestEvent(b,emulabeller.viewPort.curMouseMoveSegmentStart);c?this.moveBoundary(c.startSample,emulabeller.viewPort.curMouseMoveTierName):emulabeller.alertUser("Error","closest segment is null?!?!?!?")}emulabeller.drawBuffer(),this.history()},snapToNearestZeroCrossing:function(){for(var a=emulabeller.backend.currentBuffer.getChannelData(0),b=a.subarray(0,emulabeller.viewPort.curMouseMoveSegmentStart+1),c=a.subarray(emulabeller.viewPort.curMouseMoveSegmentStart,emulabeller.backend.currentBuffer.length),d=0,e=0;e<c.length;e++)if(c[e]<0&&c[e+1]>0||c[e]>0&&c[e+1]<0){d=e;break}for(var f=0,e=b.length;e>0;e--)if(b[e]<0&&b[e-1]>0||b[e]>0&&b[e-1]<0){f=emulabeller.viewPort.curMouseMoveSegmentStart-e;break}f>d?this.moveBoundary(emulabeller.viewPort.curMouseMoveSegmentStart+d+1,emulabeller.viewPort.curMouseMoveTierName):this.moveBoundary(emulabeller.viewPort.curMouseMoveSegmentStart-f,emulabeller.viewPort.curMouseMoveTierName),emulabeller.drawBuffer(),this.history()},selectPrevNextEvent:function(a){var b,c=this.getSelectedTier();null!=c&&(b=a?this.nextEvent(c,emulabeller.viewPort.selectS-1):this.nextEvent(c,emulabeller.viewPort.selectE+1),null!==b&&(emulabeller.viewPort.resetSelection(c.events.length),emulabeller.viewPort.setSelectSegment(c,b,!0,this.getCanvas(c.TierName)),emulabeller.viewPort.select(b.startSample,b.startSample+b.sampleDur+1),emulabeller.drawBuffer()))},addRemoveTimeToSelectedSegs:function(a,b){var c=this.getSelectedTier(),d=100;if(null!=c){var e=emulabeller.viewPort.getAllSelected(c),f=emulabeller.viewPort.countSelected(),g=!1,h=1;if(!a)for(s in e){var i=parseInt(s),j=c.events[i];if(j.sampleDur<d)return}h=1;var k;for(s in e){k=parseInt(s);break}var l=c.events[k],m=c.events[k-1];c.events[e.length-1];var n=c.events[e.length];if(a&&!b&&n.sampleDur>d||!a&&!b&&l.sampleDur>d||a&&b&&m.sampleDur>d||!a&&b&&l.sampleDur>d){a?b?emulabeller.viewPort.select(l.startSample-f*d,n.startSample+(f-1)*d):emulabeller.viewPort.select(l.startSample,n.startSample+f*d):b?emulabeller.viewPort.select(l.startSample+f*d,n.startSample-(f-1)*d):emulabeller.viewPort.select(l.startSample,n.startSample-f*d);for(s in e){var i=parseInt(s);i==e.length-1&&(g=!0);var o=c.events[i-1],j=c.events[i],p=c.events[i+1];a?b?(j.startSample=j.startSample-d*(f-h+1),j.sampleDur=j.sampleDur+d*(f-h+1),o.sampleDur=o.sampleDur-d*(f-h+1)):(j.sampleDur=j.sampleDur+d,p.startSample=p.startSample+d*h,g&&(p.sampleDur=p.sampleDur-d*h)):b?(j.startSample=j.startSample+d*(f-h+1),j.sampleDur=j.sampleDur-d*(f-h+1),o.sampleDur=o.sampleDur+d*(f-h+1)):(j.sampleDur=j.sampleDur-d,p.startSample=p.startSample-d*h,g&&(p.sampleDur=p.sampleDur+d*h)),h+=1}emulabeller.drawBuffer(),this.history()}}},moveSelectedTierUpDown:function(a){if(emulabeller.internalMode==emulabeller.EDITMODE.STANDARD){var b=this.getSelectedTier(),c=$("#cans div canvas").first().attr("id"),d=$("#cans div canvas").last().attr("id");if(b||(emulabeller.viewPort.setSelectTier(c),b=this.getTier(c),emulabeller.drawBuffer()),a&&b.name==c||!a&&b.name==d)return;var e=this.getNeighboringTier(emulabeller.viewPort.MouseTierName,a,!1);console.log(emulabeller.viewPort.MouseTierName),e&&(emulabeller.viewPort.resetSelection(b.events.length),emulabeller.viewPort.setSelectTier(e.TierName),emulabeller.drawBuffer())}},moveSelctionToCurMouseBoundary:function(){emulabeller.internalMode==emulabeller.EDITMODE.STANDARD&&(console.log("moveSelctionToCurMouseBoundary"),emulabeller.viewPort.select(emulabeller.viewPort.curMouseMoveSegmentStart,emulabeller.viewPort.curMouseMoveSegmentStart),emulabeller.drawBuffer())}},EmuLabeller.DropBoxHandler={readDropbox:function(a){var b=this,c=new XMLHttpRequest;c.open("GET",a,!1),c.onreadystatechange=function(a){4===c.readyState&&(200===c.status?(console.log("here..."),console.log(a.target.response),emulabeller.newFileType=0,emulabeller.parseNewFile(b.str2ab(a.target.response))):console.log("Error",c.statusText))};try{c.send(null)}catch(d){alert(d)}return 200==c.status?c.responseText:(alert("Error - File not found in Dropbox public folder"),null)},openDropBox:function(){var a=this;console.log("open from dropbox"),Dropbox.choose({linkType:"direct",success:function(b){console.log("Here's the file link:"+b[0].link),a.readDropbox(b[0].link)}})},str2ab:function(a){for(var b=new ArrayBuffer(2*a.length),c=new Uint16Array(b),d=0,e=a.length;e>d;d++)c[d]=a.charCodeAt(d);return b}};var emulabeller=function(){"use strict";var a=!0,b={tiers:[],canvases:[]},c=document.querySelector("#wave"),d=document.querySelector("#spectrogram"),e=document.querySelector("#scrollbar"),f=document.querySelector("#resizer"),g=document.querySelector("#timeline"),h=document.querySelector("#tiers"),i=document.getElementById("cans"),j=document.querySelector("#fileSelect"),k=document.getElementById("serverSelect"),l=document.querySelector("#spectroworker"),m=Object.create(EmuLabeller);m.init({osciCanvas:c,specCanvas:d,scrollCanvas:e,tierInfos:b,draggableBar:f,timeline:g,tiers:h,cans:i,fileSelect:j,showLeftPush:k,spectroworker:l,internalCanvasWidth:"2048",internalCanvasHeightSmall:"128",internalCanvasHeightBig:"64",mode:"standalone",initLoad:a});var n=null!==navigator.userAgent.match(/iPad/i);if((n||a)&&(m.iohandler.xhrLoad("testData/msajc003.wav","arraybuffer",0),m.iohandler.xhrLoad("testData/msajc003.TextGrid","text",3)),$("#fileGetterBtn")[0].addEventListener("change",m.fileAPIread,!1),document.querySelector("#fileSelect").addEventListener("click",function(){document.querySelector("#fileGetterBtn").click()},!1),$(document).bind("keydown",function(a){var b=a.keyCode?a.keyCode:a.which;8==b&&emulabeller.keyBindingAllowed(b)&&(a.preventDefault(),"seg"==emulabeller.tierHandler.getSelectedTierType()||"point"==emulabeller.tierHandler.getSelectedTierType()?emulabeller.tierHandler.deleteSelected():emulabeller.alertUser("Error","Please mark one of more segments first!")),9==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.isEditing&&(emulabeller.tierHandler.saveLabelName(this),emulabeller.tierHandler.removeLabelDoubleClick()),a.shiftKey?emulabeller.tierHandler.selectPrevNextEvent(!0):emulabeller.tierHandler.selectPrevNextEvent(!1)),13==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.isEditing?(emulabeller.tierHandler.saveLabelName(this),emulabeller.tierHandler.removeLabelDoubleClick()):emulabeller.tierHandler.addSegmentAtSelection(),a.preventDefault()),16==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.history(),a.preventDefault()),18==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.history(),a.preventDefault()),27==b&&emulabeller.internalMode==m.EDITMODE.LABEL_RENAME&&(emulabeller.tierHandler.removeLabelDoubleClick(),a.preventDefault()),32==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.playPauseInView(),a.preventDefault()),38==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.internalMode==emulabeller.EDITMODE.STANDARD,emulabeller.tierHandler.moveSelectedTierUpDown(!0),a.preventDefault()),40==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.internalMode==emulabeller.EDITMODE.STANDARD,emulabeller.tierHandler.moveSelectedTierUpDown(!1),a.preventDefault()),46==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.deleteBorder(),a.preventDefault()),65==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.shiftViewP(0),a.preventDefault()),66==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.snapSelectedBoundaryToNearestTopOrBottom(!1),a.preventDefault()),67==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.moveSelctionToCurMouseBoundary(),a.preventDefault()),68==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.shiftViewP(1),a.preventDefault()),69==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.zoomSel(),a.preventDefault()),70==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.playInMode("all"),a.preventDefault()),71==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.selectSegmentsUnderSelection(),a.preventDefault()),78==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.renameTier(),a.preventDefault()),79==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.externalMode==m.USAGEMODE.STANDALONE&&$("#fileGetterBtn").click(),emulabeller.externalMode==m.USAGEMODE.SERVER&&emulabeller.openSubmenu(),a.preventDefault()),81==b&&emulabeller.keyBindingAllowed(b)&&(a.metaKey||(emulabeller.setView(-1/0,1/0),a.preventDefault())),82==b&&emulabeller.keyBindingAllowed(b)&&(a.metaKey||(emulabeller.playInMode("sel"),a.preventDefault())),83==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.zoomViewPort(0),a.preventDefault()),84==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.snapSelectedBoundaryToNearestTopOrBottom(!0),a.preventDefault()),87==b&&emulabeller.keyBindingAllowed(b)&&(a.metaKey||(emulabeller.zoomViewPort(1),a.preventDefault())),88==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.snapToNearestZeroCrossing(),a.preventDefault()),90==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.goBackHistory(),a.preventDefault()),187==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.addRemoveTimeToSelectedSegs(!0,!1),a.preventDefault()),189==b&&emulabeller.keyBindingAllowed(b)&&(a.shiftKey?emulabeller.tierHandler.addRemoveTimeToSelectedSegs(!1,!0):emulabeller.tierHandler.addRemoveTimeToSelectedSegs(!1,!1),a.preventDefault()),221==b&&emulabeller.keyBindingAllowed(b)&&(emulabeller.tierHandler.addRemoveTimeToSelectedSegs(!0,!0),a.preventDefault()),console.log(b)}),/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)){var o=document.getElementById("timeline"),p=Hammer(o).on("touch",function(){});p=Hammer(o).on("doubletap",function(){emulabeller.zoomSel()}),p=Hammer(o).on("dragleft",function(){emulabeller.shiftViewP(1)}),p=Hammer(o).on("dragright",function(){emulabeller.shiftViewP(0)}),p=Hammer(o).on("dragdown",function(a){emulabeller.zoomViewPort(1),a.preventDefault()}),p=Hammer(o).on("dragup",function(){emulabeller.zoomViewPort(0)})}return m.start(),m}();
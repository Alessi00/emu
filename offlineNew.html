
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <script type="text/javascript" src="jquery-1.9.1.js"></script>
    <script type="text/javascript" src="dsp.js"></script>
    <style>
        * {
        	color: #fff;
            font-family: sans-serif;
        }
        
    </style>
	
</head>
<body style="background-color: #444;">
<center>
<canvas id="myCanvas" width="1024" height="256" style="display: float; background-color:#fff;">
</canvas>
<br />


FFTSize : 
<select name="fft" id="myfft">
  <option value="8">8</option>
  <option value="16">16</option>
  <option value="32">32</option>
  <option value="64">64</option>
  <option value="128">128</option>
  <option value="256">256</option>
  <option value="512" selected>512</option>
  <option value="1024">1024</option>
  <option value="2048">2048</option>  
</select>
&nbsp; &nbsp; &nbsp; 
Step : 
<select name="stepping" id="mystepping">
  <option value="8">8</option>
  <option value="16">16</option>
  <option value="32">32</option>
  <option value="64">64</option>
  <option value="128">128</option>
  <option value="256">256</option>
  <option value="512" selected>512</option>
  <option value="1024">1024</option>
  <option value="2048">2048</option>
</select> (<span id="Packets"></span>)
&nbsp; &nbsp; &nbsp;
Offset : 
<select name="offset" id="myoffset">
  <option value="0" selected>0</option>
  <option value="4">4</option>
  <option value="8">8</option>
  <option value="16">16</option>
  <option value="32">32</option>
  <option value="64">64</option>
  <option value="128">128</option>
  <option value="256">256</option>
  <option value="512">512</option>
  <option value="1024">1024</option>
  <option value="2048">2048</option>
</select> (<span id="currentoffset"></span>)
&nbsp; &nbsp; &nbsp;
Channels : 
<select name="channel" id="mychannel">
  <option value="1" slected>1</option>
  <option value="2">2</option>
</select>
&nbsp; &nbsp; &nbsp;
Sample Rate : 
<input type="text" name="smaplerate" placeholder="44100" id="mysamplerate" style="color:#000;">
&nbsp; &nbsp; &nbsp; 
<br />
Start : 
<input type="text" name="start" placeholder="00:00:00" id="start" style="color:#000;" size="8">
&nbsp; &nbsp; &nbsp; 
End : 
<input type="text" name="end" placeholder="00:00:00" id="end" style="color:#000;" size="8">
&nbsp; &nbsp; &nbsp; 
Length : <span id="Length"></span>
<input type="submit" name="smaplerate" placeholder="44100" value="save" style="color:#000;" onClick="update();">

</center>
<script type="text/javascript">

	// default values
	var channels = 1;
    var fftSize = 512;
    var sampleRate = 44100;
    var step = 512;
    var offset = 0;
    var background = "#fff";
    
    // other vars
    var context = new webkitAudioContext;
    var offlineContext = new webkitOfflineAudioContext(channels,2*sampleRate,sampleRate);
	var javascriptNode = context.createScriptProcessor(fftSize, channels, channels);
    var canvas_width = document.getElementById("myCanvas").width;
    var canvas_height = document.getElementById("myCanvas").height;   
    var length = document.getElementById("Length"); 
    var pack = document.getElementById("Packets"); 
    var coffset = document.getElementById("currentoffset"); 
    var offline = document.getElementById("myCanvas");
    var octx = $("#myCanvas").get()[0].getContext("2d");
    var otempCanvas = document.createElement("canvas");
    var otempCtx = otempCanvas.getContext("2d");
    var fft, spectrum, frameBufferLength, packets,audioBuffer,offSet;
    otempCanvas.width=canvas_width;
    otempCanvas.height=canvas_height;
    octx.fillStyle = background;
	octx.fillRect(0, 0, canvas_width, canvas_height);

	// initial function launch
    loadSound("data/msajc003.wav");
    
    function loadSound(url) {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';
        request.onload = function () {
        
            offlineContext.decodeAudioData(request.response, function (buffer) {
  				renderLine(buffer); 	// send pcm buffer to renderLine function
            }, function (buffer) { alert("error filling offline buffer"); });    
            
           /*context.decodeAudioData(request.response, function (buffer) {
           	setTimeout(function(){renderSound(buffer)},1000);	// enable to play sound after 1 sec
            }, function (buffer) { alert("error filling buffer"); }); */
            
        }
        request.send();
    }
  
	function renderSound(temp) {    					// function to play sound
        sourceNode = context.createBufferSource();
        sourceNode.buffer = temp;
        sourceNode.connect(context.destination);
        sourceNode.noteOn(0);
        sourceNode.loop = false;
	}    

	function renderLine(temp) {							// function to apply FFT and call drawOfflineSpectogram
        	fft = new FFT(fftSize, sampleRate);
        	var completeLength = temp.length;
        	var rest = completeLength % step;
        	packets = Math.floor(completeLength/step);						// TODO TIME Selection !
        	rest!=0 && packets++;
    		length.innerHTML = temp.duration+" sec";
    		pack.innerHTML = packets+" fft runs";
    		coffset.innerHTML = offset;
            for(var i=0;i<packets;i++) {
            	var signal = new Float32Array(fftSize);
            	for(var j=0;j<fftSize;j++) {
            		var dataIndex = i*step+j+offset;
            		if(dataIndex>completeLength)
            			signal[j] = 0;
            		else
	            		signal[j] = temp.getChannelData(0)[dataIndex];			// TODO Multichannel !
	            }
	            fft.forward(signal);
	            drawOfflineSpectogram(fft.spectrum);
            }   	
            rescaleSpectogram(packets);
	}    
     
     function drawOfflineSpectogram(array) {			// function to draw one Line on Canvas using Array data
		var max = Math.max.apply(Math, array);
        otempCtx.drawImage(offline, 0, 0, canvas_width, canvas_height);
        for (var i = 0; i < array.length; i++) {							// TODO fftSize/2 bigger than image !
         	var curVal = 255-Math.floor(255*array[i]/max);	
         	octx.fillStyle = 'rgb(' + curVal + ',' + curVal +',' + curVal + ')';
            octx.fillRect(canvas_width - 1, canvas_height - i, 1, 1);
        }
        octx.translate(-1, 0);
        octx.drawImage(otempCanvas, 0, 0, canvas_width, canvas_height, 0, 0, canvas_width, canvas_height);
        octx.setTransform(1, 0, 0, 1, 0, 0);
    }  
    
    function rescaleSpectogram(packets) {				// function to rescale canvas to actual size
    													// TODO: fftSize/2 bigger than image ! maybe extra draw canvas
    	var canvasCopy = document.createElement("canvas");
    	var copyContext = canvasCopy.getContext("2d");
    	canvasCopy.width = canvas_width;
        canvasCopy.height = canvas_height;
        var offsetY = canvas_height-(fftSize/2);
        copyContext.drawImage(offline, canvas_width-packets, offsetY,packets,(fftSize/2),0,0,canvas_width,canvas_height);
        octx.drawImage(canvasCopy,0,0, canvas_width, canvas_height);
    }  
    
    function update() {									// function to set new values from html form an load sound again
    	var newfft = document.getElementById("myfft").value;
    	var newchannel = document.getElementById("mychannel").value;
    	var newsamepl = document.getElementById("mysamplerate").value;
    	var newsstep = document.getElementById("mystepping").value;
    	var newoffset = document.getElementById("myoffset").value;
    	if(newsamepl=="") newsamepl=44100;
    	else sampleRate = parseInt(newsamepl,10);
    	fftSize = parseInt(newfft,10);
    	channels= parseInt(newchannel,10); 
    	step= parseInt(newsstep,10);   
    	offset = parseInt(newoffset,10);  	
    	loadSound("data/msajc003.wav");
    }

</script>

</body>
</html>
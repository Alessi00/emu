
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <script type="text/javascript" src="js/jquery-1.9.1.js"></script>
    <style>
        * {
            font-family: sans-serif;
        }
    </style>

</head>
<body style="background-color: white;">

<canvas id="offline" width="400" height="128" style="display: float; background-color: red ;"></canvas>

<button onclick="renderNextLine();">paint next line</button>


<script type="text/javascript">

	var i = 0;
    var sampleLength = 256;
    var fftSize = 512;
    var sampleRate = 44100;
    // var context = new webkitAudioContext;
    var offlineContext = new webkitOfflineAudioContext(1,2*sampleRate,sampleRate);
    var ojavascriptNode = offlineContext.createScriptProcessor(sampleLength, 1, 1); //sampleLength

    var oanalyser = offlineContext.createAnalyser();
    oanalyser.smoothingTimeConstant = 0;
    oanalyser.fftSize = fftSize;

    //build graph
    oanalyser.connect(ojavascriptNode);
    ojavascriptNode.connect(offlineContext.destination);

    var audioBuffer;
    var analyser;
    var javascriptNode;
    var data_array = new Uint8Array(fftSize);
    var mega_array = new Array(1024);	
    var octx = $("#offline").get()[0].getContext("2d");
    

    // create a temp canvas we use for copying
    var otempCanvas = document.createElement("canvas");
    var otempCtx = otempCanvas.getContext("2d");
    otempCanvas.width=400;
    otempCanvas.height=128;


    var chunks =[];
    var curChunk=0;

    // load the sound
    loadSound("data/msajc003.wav");

    // load the specified sound
    function loadSound(url) {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';

        // When loaded decode the data
        request.onload = function () {
        

            offlineContext.decodeAudioData(request.response, function (buffer) {
        		
        	
        	var completeLength = buffer.length;
        	var packets = Math.floor(completeLength/sampleLength);
        	var rest = completeLength % sampleLength;
        	rest!=0 && packets++;
            var temp = new Float32Array(sampleLength);
            for(var i=0;i<packets;i++) {
            	for(var j=0;j<sampleLength;j++) {
	            	temp[j] = buffer.getChannelData(0)[i*sampleLength+j];
	            }
               chunks.push(temp);
            }
            
            renderNextLine();
                
            }, function (buffer) { alert("error filling offline buffer"); });    
            
        }
        request.send();
    }
    


	function renderNextLine() {

    	// console.log(chunks);
        var aBuffer = offlineContext.createBuffer(1,sampleLength,sampleRate);
        aBuffer.getChannelData(0).set(chunks[curChunk]);
        
        var osourceNode = offlineContext.createBufferSource();
        osourceNode.buffer = aBuffer;
        
        // connect osourceNode to graph
        osourceNode.connect(oanalyser);
        osourceNode.loop = false;
        //osourceNode.start(0);


        offlineContext.startRendering();
        console.log(offlineContext);


        // curChunk += 1;
        //console.log(curChunk);
    }
    

    // log if an error occurs
    function onError(e) {
        console.log(e);
    }



    ojavascriptNode.onaudioprocess = function () {

        console.log("on audio process");
        // var array = new Uint8Array(oanalyser.frequencyBinCount);
        // oanalyser.getByteFrequencyData(array);

        //if (osourceNode.playbackState == osourceNode.PLAYING_STATE) {
        // odrawSpectrogram(array);
        //}
    }
 
    offlineContext.oncomplete = function(event) {
    
        console.log('rendering complete');

        console.log(offlineContext);
        // osourceNode.stop(0);

        //var source = offlineContext.createBufferSource();
        //source.buffer = event.renderedBuffer;
        //source.connect(offlineContext.destination);
        //source.noteOn(0);
        
    };

     
     function odrawSpectrogram(array) {
        // copy the current canvas onto the temp canvas
        var offline = document.getElementById("offline");
		var max = Math.max.apply(Math, array);
        otempCtx.drawImage(offline, 0, 0, 400, 128);

        // iterate over the elements from the array
        for (var i = 0; i < array.length; i++) {
            // draw each pixel with the specific color
            var value = array[i];
         	var curVal = 255-Math.floor(255*value/max);		// with the specific color
         	
         	octx.fillStyle = 'rgb(' + curVal + ',' + curVal +',' + curVal + ')';
			//octx.fillStyle = 'rgb(0,0,0)';
            // draw the line at the right side of the canvas
            octx.fillRect(400 - 1, 128 - i, 1, 1);
        }

        // set translate on the canvas
        octx.translate(-1, 0);
        // draw the copied image
        octx.drawImage(otempCanvas, 0, 0, 400, 128, 0, 0, 400, 128);
        
        // reset the transformation matrix
        octx.setTransform(1, 0, 0, 1, 0, 0);
        
    }    



</script>

</body>
</html>
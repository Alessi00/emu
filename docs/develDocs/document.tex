\documentclass[A4,12pt, utf8]{article}
\usepackage{tikz}
\usepackage[
    backend=biber,
    style=authoryear-icomp,
    sortlocale=de_DE,
    natbib=true,
    url=false, 
    doi=true,
    eprint=false
]{biblatex}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{hyperref}
\usepackage{pgf}
\usepackage{tikz}
\usetikzlibrary{arrows,automata}
\usepackage{todonotes}
\usepackage{dirtree}
\usepackage{pdflscape}
\usepackage{csquotes}
\MakeOuterQuote{"}


\newcommand{\tinytodo}[2][]
   {\todo[caption={#2}, size=\small, #1]{\renewcommand{\baselinestretch}{0.5}\selectfont#2\par}}

\colorlet{punct}{red!60!black}
\definecolor{background}{HTML}{EEEEEE}
\definecolor{delim}{RGB}{20,105,176}
\colorlet{numb}{magenta!60!black}

\lstdefinelanguage{json}{
    basicstyle=\normalfont\ttfamily,
    % numbers=left,
    % numberstyle=\scriptsize,
    % stepnumber=1,
    % numbersep=8pt,
    showstringspaces=false,
    breaklines=true,
    frame=lines,
    backgroundcolor=\color{background},
    literate=
     *{0}{{{\color{numb}0}}}{1}
      {1}{{{\color{numb}1}}}{1}
      {2}{{{\color{numb}2}}}{1}
      {3}{{{\color{numb}3}}}{1}
      {4}{{{\color{numb}4}}}{1}
      {5}{{{\color{numb}5}}}{1}
      {6}{{{\color{numb}6}}}{1}
      {7}{{{\color{numb}7}}}{1}
      {8}{{{\color{numb}8}}}{1}
      {9}{{{\color{numb}9}}}{1}
      {:}{{{\color{punct}{:}}}}{1}
      {,}{{{\color{punct}{,}}}}{1}
      {\{}{{{\color{delim}{\{}}}}{1}
      {\}}{{{\color{delim}{\}}}}}{1}
      {[}{{{\color{delim}{[}}}}{1}
      {]}{{{\color{delim}{]}}}}{1},
}
% \addbibresource{linked.bib}

\newcounter{treeline}

\newcommand{\treeroot}[1]{% Title
\node[above] at (0,0) {#1};%
\setcounter{treeline}{0}
}

\newcommand{\treeentry}[2]{% Title, Level
\draw[->] (#2-1,-\value{treeline}/2) -- (#2-1,-\value{treeline}/2-0.5) -- (#2+0.5,-\value{treeline}/2-0.5) node[right] {#1};
\stepcounter{treeline}
}

\newcommand{\altentry}[2]{% Title, Level
\draw[->] (#2-1,-\value{treeline}/2) -- (#2-1,-\value{treeline}/2-0.5) -- (#2+0.5,-\value{treeline}/2-0.5) node[right] {#1};
\foreach \x in {1,...,#2}
{   \draw (\x-1,-\value{treeline}/2) -- (\x-1,-\value{treeline}/2-0.5);
}
\stepcounter{treeline}
}


\title{emuLVC - Stucture of the angularjs app}
\author{Raphael Winkelmann}
\date{\today}
\begin{document}
  % \maketitle

\section{Schematic DB file structure on disc}

\begin{tikzpicture}
\treeroot{\textbf{dbRootFolder/}}
\altentry{\textit{global\_DBconfig.json$^{*2}$}}{1}
\altentry{\textbf{0001\_ses/$^{*3}$}}{1}
\altentry{\textbf{0002\_ses/}}{1}
\altentry{\textit{0002\_sesmeta$^{*6}$}}{2}
\altentry{\textbf{bundle1\_bndl/$^{*4}$}}{2}
\altentry{\textbf{bundle2\_bndl/}}{2}
\altentry{\textit{bundle2\_bndlmeta.json$^{*7}$}}{3}
\altentry{\textit{bundle2.wav}}{3}
\altentry{\textit{bundle2\_annot.json$^{*5}$}}{3}
\altentry{\textit{bundle2.fms}}{3}
\altentry{\textit{bundle2.f0}}{3}
\altentry{\dots}{3}
\altentry{\textbf{bundle3\_bndl/}}{2}
\altentry{\dots}{2}
\altentry{\textbf{0003\_ses/}}{1}
\altentry{\dots}{1}
\end{tikzpicture}


\begin{itemize}
  \item $^{*2}$: global config information file (similar to \textit{.tpl} file of old EMU). Specifies things like structure of hierarchy and possible perspectives to look at the DB (relevant for layout of labeler). \textit{\_DBconfig.json} is a fix suffix and the prefix should be the same as the database name field in the file itself.
  \item $^{*3}$: \textit{\_ses} is a fix suffix specifying the folder as being a session folder. Preceding this suffix can be anything as long it is unique on a session level (OS won't let you name two folders the same anyway...). If no session is required a dummy session is used called 0000\_ses.
  \item $^{*4}$: a bundle encapsulates what used to be known as an utterance in a folder. This includes signal files (\textit{wav, SSFF}) and the new annotation file (see $^{*5}$). Unknown file extensions are ignored. \textit{\_bndl} is a fix suffix specifying the folder as being a bundle folder.
  \item $^{*5}$: annotation file containing label and level information as well as hierarchical information (see listing 1). \textit{\_annot.json} is a fix suffix and the prefix should be the same as the bundle name.
  \item $^{*6}$: Optional session meta information file. Simple key-value json of the form \{"key1":"value1", "key2":"value2"\}
  \item $^{*7}$: Optional bundle meta information file. Simple key-value json of the form \{"key1":"value1", "key2":"value2"\}
\end{itemize}




\section{File structure of json files}

Until the labeler can also display the hierarchical structure of the annotation it will only 
display a subset of the levels namely \textbf{SEGMENT} and \textbf{EVENT}

\lstinputlisting[caption=instanceOfglobalDBconfig.json, label=idsr, language=json,firstnumber=1]{../../validators/exampleInstances/instanceOfglobalDBconfig.json}


\begin{itemize}
  \item \texttt{dbName + levelName +...} specific like that or just \texttt{name}?
  \item \texttt{legalValues} specifies the possible entries that are legal. For example \texttt{["a","b","c"]} would only allow the labels a, b and c to be used. If undefined or empty $\rightarrow$ no restrictions. Good idea?? Or should it always be set?
  \item \texttt{"type":"txt"} what types are supported? Should we support anything else but \texttt{"TEXT"}. If no then why specify a field for it?
  \item \texttt{constaints[0].type} can be \texttt{"ONE\_TO\_ONE"}, \texttt{"ONE\_TO\_MANY"}or \texttt{"MANY\_TO\_MANY"}
  \item should we rename \texttt{constaints} to \texttt{links}?? This would make it parallel to the data rep.
  \item should \texttt{constaints} have a label??? Do we need that?
  \item should restrictions/key commands also be defined in perspectives?
  \item \texttt{perspectives.signalCanvases.order} \texttt{"OSCI"} and \texttt{"SPEC"} are always available! Other entries have to be predefined in tracks
  \item \texttt{FORMANTS} is a special reserved track name that can be manipulated (== formant corrections)
\end{itemize}


\lstinputlisting[caption=instanceOfAnnotationFile.json, label=idsr, language=json,firstnumber=1]{../../validators/exampleInstances/instanceOfAnnotationFile.json}


\begin{lstlisting}[caption=EMU-webApp internal derived signal representation, label=idsr, language=json,firstnumber=1]
{
  "filepath": "/path/to/msajc003.fms",
  "sampleRate" = 200,
  "origFreq" = 20000,
  "startTime" = 0.0025,
  "columns" = [
  {"name": "fm",
    "length": 4,
    "ssffDataType": "SHORT"
    "values" : [[0, 1042, 2072, 3170],
                [0, 1260, 2122, 3118],
                [0, 1339, 2293, 3258],
                ...]},
  {"name": "bw",
    "length": 4,
    "ssffDataType": "SHORT"
    "values" : [[0, 886, 371, 890],
                [0, 724, 567, 826],
                [0, 410, 664, 740],
                ...]}
  ]
}
\end{lstlisting}

\clearpage

%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
\section{Websocket protocol definition (Version 0.0.1)}

All notation in nodejs / javascript syntax. The \texttt{request.callbackID} variable is a UUID that is echoed by the server on every request to remap the reply to the request on the client. \texttt{xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx} is used as a placeholder for all UUIDs.


\subsection{The Protocol}

%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\texttt{GETPROTOCOL}}
\begin{center}
  \line(1,0){250}

  \textit{Initial request to see if client and server speak the same protocol.}

  \line(1,0){250}
\end{center}


\begin{lstlisting}[caption=Request content, language=json]
{
  'type': 'GETPROTOCOL', 
  'callbackID': 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
}
\end{lstlisting}

\begin{lstlisting}[caption=Reply content, language=json]
{
  'callbackID': request.callbackID,
  'data': {
    'protocol': 'EMU-webApp-websocket-protocol',
    'version': '0.0.1'
  },
  'status': {
    'type': 'SUCCESS',
    'message': ''
  }
}
\end{lstlisting}

%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\texttt{GETDOUSERMANAGEMENT}}
\begin{center}
  \line(1,0){250}

  \textit{Ask server if a it wishes to perform user management (will toggle login dialog if YES)}

  \line(1,0){250}
\end{center}


\begin{lstlisting}[caption=Request content, language=json]
{
  'type': 'GETDOUSERMANAGEMENT', 
  'callbackID': 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
}
\end{lstlisting}

\begin{lstlisting}[caption=Reply content, language=json]
{
  'callbackID': request.callbackID,
  'data': 'NO'
  'status': {
    'type': 'SUCCESS',
    'message': ''
  }
}
\end{lstlisting}

%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\texttt{LOGONUSER}}

\todo[inline]{Write LOGONUSER!!!}

\begin{lstlisting}[caption=Request content, language=json]
{
  'type': 'LOGONUSER',
  'data': {
    'userName': 'smith', 
    'userPwd':'mySecretPwd'
  },
  'callbackID': 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
}
\end{lstlisting}

%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\texttt{GETGLOBALDBCONFIG}}
\begin{center}
  \line(1,0){250}

  \textit{Next the globalDBconfig.json is requested from the DB. This is needed for the level definitions (future version) $+$ the legal values of each level $+$ the custom config specified in the field EMU-webAppConfig}

  \line(1,0){250}
\end{center}


\begin{lstlisting}[caption=Request content, language=json]
{
  'type': 'GETGLOBALDBCONFIG', 
  'callbackID': 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
}
\end{lstlisting}

\begin{lstlisting}[caption=Reply content, language=json]
{
  'callbackID': request.callbackID,
  'data': configData,
  'status': {
    'type': 'SUCCESS',
    'message': ''
  }
}
\end{lstlisting}
Where \texttt{configData} is the javascript object representing \texttt{globalDBconfig.json}

%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\texttt{GETBUNDLELIST}}
\begin{center}
  \line(1,0){250}

  \textit{Next a bundlelist is requested.}

  \line(1,0){250}
\end{center}


\begin{lstlisting}[caption=Request content, language=json]
{
  'type': 'GETBUNDLELIST', 
  'callbackID': 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
}
\end{lstlisting}

\begin{lstlisting}[caption=Reply content, language=json]
{
  'callbackID': request.callbackID,
  'data': bundleList,
  'status': {
    'type': 'SUCCESS',
    'message': ''
  }
}
\end{lstlisting}

%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\texttt{GETBUNDLE}}
\begin{center}
  \line(1,0){250}

  \textit{After receiving the bundleList by default the first bundle in the bundleList is requested. This request is also sent when the user clicks a bundle in the bundleList}

  \line(1,0){250}
\end{center}


\begin{lstlisting}[caption=Request content, language=json]
{
  'type': 'GETBUNDLE',
  'name': 'msajc003',
  'callbackID': 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
}
\end{lstlisting}

\begin{lstlisting}[caption=Reply content, language=json]
{
  'callbackID': request.callbackID,
  'data': bundleData,
  'status': {
    'type': 'SUCCESS',
    'message': ''
  }
}
\end{lstlisting}
Where \texttt{bundleData} is the javascript object containing all the values of ssffTracks + audio + annotation.json in the DB (see example bundle for details).

%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\texttt{SAVEBUNDLE}}
\begin{center}
  \line(1,0){250}

  \textit{Function to be called if the user saves a loaded bundle (by pushing the save button).}

  \line(1,0){250}
\end{center}


\begin{lstlisting}[caption=Request content, language=json]
{
  'type': 'SAVEBUNDLE',
  'data': bundleData,
  'callbackID': 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
}
\end{lstlisting}
Where \texttt{bundleData} is the javascript object OPTIONALLY containing the values of ssffTracks + audio + annotation.json in the DB (see example bundle for details). It only sends the data that has been altered.

\begin{lstlisting}[caption=Reply content, language=json]
{
  'callbackID': request.callbackID,
  'status': {
    'type': 'SUCCESS',
    'message': ''
  }
}
\end{lstlisting}


%%%%%%%%%%%%%%%%%%%%%%
\subsection{Error handling}

If an error occurs with any of the request types above a response should still be sent to the client. The status of this response should be set to \texttt{ERROR} and an error message should be given in the message field. This message will then be displayed on the client.

\begin{lstlisting}[caption=ERROR reply content, language=json]
{
  'callbackID': request.callbackID,
  'status': {
    'type': 'ERROR',
    'message': 'An error occured trying to read a file from disk. Please make sure: /path/to/file exists or check the config...
  }
}
\end{lstlisting}

%%%%%%%%%%%%%%%%%%
\subsection{Example bundle JSON}

\lstinputlisting[caption=exampleBundle.json, label=idsr, language=json,firstnumber=1]{../../validators/exampleInstances/exampleBundle.json}

%%%%%%%%%%%%%%%%%%%%%%
% \begin{landscape}
% \section{In memory representation of DB (C++ graph)}

% \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=2.8cm,
%                     semithick]
%   \tikzstyle{every state}=[fill=white,text=black]

%   \node[initial,state] (A)                    {0};
%   \node[state]         (B) [below left of=A] {1};
%   \node[state]         (C) [below right of=A] {2};
%   \node[state]         (D) [below left of=B] {3};
%   \node[state]         (E) [right of=D] {4};
%   \node[state]         (F) [below left of=C] {5};
%   \node[state]         (G) [right of=F] {6};

%   %first level
%   \node[state]         (H) [below left of=D] {7};
%   \node[state, fill=black!20]         (I) [right of=H] {8};
%   \node[state, fill=black!20]         (J) [right of=I] {9};

%   % second level
%   \node[state]         (K) [below of=H] {10};
%   \node[state, fill=black!20]         (L) [right of=K] {11};
%   \node[state, fill=black!20]         (M) [right of=L] {12};
%   \node[state, fill=black!20]         (N) [right of=M] {13};
%   \node[state, fill=black!20]         (O) [right of=N] {14};

%   %third level
%   \node[state]         (P) [below of=K] {15};
%   \node[state, fill=black!20]         (Q) [right of=P] {16};
%   \node[state, fill=black!20]         (R) [right of=Q] {17};
%   \node[state, fill=black!20]         (S) [right of=R] {18};
%   \node[state, fill=black!20]         (T) [right of=S] {19};
%   \node[state, fill=black!20]         (U) [right of=T] {20};
%   \node[state, fill=black!20]         (V) [right of=U] {21};
%   \node[state, fill=black!20]         (W) [right of=V] {22};
%   \node[state, fill=black!20]         (X) [right of=W] {23};

%   \path (A) edge              node {SES:1} (B)
%             edge              node {SES:2} (C)
%         (B) edge              node {BNDL:1} (D)
%             edge              node {BNDL:2} (E)
%         (C) edge              node {BNDL:3} (F)
%             edge              node {BNDL:4} (G)
%         (D) edge              node {LEV:1} (H)
%             edge              node {LEV:2} (K)
%             edge              node {LEV:3} (P)
%         (H) edge              node {FIRST} (I)
%         (K) edge              node {FIRST} (L)
%         (P) edge              node {FIRST} (Q)
%         % item lists
%         %first level
%         (I) edge [bend left]  node {NEXT} (J)
%         (J) edge [bend left]  node {PREV} (I)
%         %second level
%         (L) edge [bend left]  node {NEXT} (M)
%         (M) edge [bend left]  node {PREV} (L)
%         (M) edge [bend left]  node {NEXT} (N)
%         (N) edge [bend left]  node {PREV} (M)
%         (N) edge [bend left]  node {NEXT} (O)
%         (O) edge [bend left]  node {PREV} (N)
%         %third level
%         (Q) edge [bend left]  node {NEXT} (R)
%         (R) edge [bend left]  node {PREV} (Q)
%         (R) edge [bend left]  node {NEXT} (S)
%         (S) edge [bend left]  node {PREV} (R)
%         (S) edge [bend left]  node {NEXT} (T)
%         (T) edge [bend left]  node {PREV} (S)
%         (T) edge [bend left]  node {NEXT} (U)
%         (U) edge [bend left]  node {PREV} (T)
%         (U) edge [bend left]  node {NEXT} (V)
%         (V) edge [bend left]  node {PREV} (U)
%         (V) edge [bend left]  node {NEXT} (W)
%         (W) edge [bend left]  node {PREV} (V)
%         (W) edge [bend left]  node {NEXT} (X)
%         (X) edge [bend left]  node {PREV} (W)
%         % hierarchy
%         (I) edge [<->,dotted] node {} (L)
%         (I) edge [<->,dotted] node {} (M)
%         (J) edge [<->,dotted] node {} (N)
%         (J) edge [<->,dotted] node {} (O)
%         (L) edge [<->,dotted] node {} (Q)
%         (L) edge [<->,dotted] node {} (R)
%         (M) edge [<->,dotted] node {} (S)
%         (M) edge [<->,dotted] node {} (T)
%         (N) edge [<->,dotted] node {} (U)
%         (N) edge [<->,dotted] node {} (V)
%         (O) edge [<->,dotted] node {} (W)
%         (O) edge [<->,dotted] node {} (X);

% \end{tikzpicture}
% \end{landscape}

\end{document}